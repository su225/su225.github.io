<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Learning Lifetime parameters in Rust: Writing a simple Lisp evaluator - Tech notes</title><meta name=description content="Link to the problem description
Brief description - We are given a valid Lisp expression. The expression types are
Integer: An integer which evaluates to the same value (positive or negative) Let: Used to introduce new variables into the scope Add: (add e1 e2) where e1 and e2 expressions evaluate to integers. It evaluates to the sum of the two Mult: (mult e1 e2) where e1 and e2 expressions evaluate to integers."><meta name=author content="Suchith J N"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"Tech notes","url":"https:\/\/su225.github.io\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/su225.github.io\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/su225.github.io\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/su225.github.io\/posts\/learning-rust-writing-lisp-evaluator\/","name":"Learning lifetime parameters in rust writing a simple lisp evaluator"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"Suchith J N"},"headline":"Learning Lifetime parameters in Rust: Writing a simple Lisp evaluator","description":"Link to the problem description\nBrief description - We are given a valid Lisp expression. The expression types are\nInteger: An integer which evaluates to the same value (positive or negative) Let: Used to introduce new variables into the scope Add: (add e1 e2) where e1 and e2 expressions evaluate to integers. It evaluates to the sum of the two Mult: (mult e1 e2) where e1 and e2 expressions evaluate to integers.","inLanguage":"en","wordCount":3758,"datePublished":"2022-08-24T10:48:17","dateModified":"2022-08-24T10:48:17","image":"https:\/\/su225.github.io\/","keywords":["leetcode, rust, learning"],"mainEntityOfPage":"https:\/\/su225.github.io\/posts\/learning-rust-writing-lisp-evaluator\/","publisher":{"@type":"Organization","name":"https:\/\/su225.github.io\/","logo":{"@type":"ImageObject","url":"https:\/\/su225.github.io\/","height":60,"width":60}}}</script><meta property="og:title" content="Learning Lifetime parameters in Rust: Writing a simple Lisp evaluator"><meta property="og:description" content="Link to the problem description
Brief description - We are given a valid Lisp expression. The expression types are
Integer: An integer which evaluates to the same value (positive or negative) Let: Used to introduce new variables into the scope Add: (add e1 e2) where e1 and e2 expressions evaluate to integers. It evaluates to the sum of the two Mult: (mult e1 e2) where e1 and e2 expressions evaluate to integers."><meta property="og:url" content="https://su225.github.io/posts/learning-rust-writing-lisp-evaluator/"><meta property="og:type" content="website"><meta property="og:site_name" content="Tech notes"><meta name=twitter:title content="Learning Lifetime parameters in Rust: Writing a simple Lisp evaluator"><meta name=twitter:description content="Link to the problem description
Brief description - We are given a valid Lisp expression. The expression types are
Integer: An integer which evaluates to the same value (positive or negative) Let: â€¦"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.101.0"><link rel=alternate href=https://su225.github.io/index.xml type=application/rss+xml title="Tech notes"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://su225.github.io/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://su225.github.io/css/syntax.css><link rel=stylesheet href=https://su225.github.io/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button>
<a class=navbar-brand href=https://su225.github.io/>Tech notes</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a title=Blog href=/>Blog</a></li><li><a title=About href=/about>About</a></li></ul></div></div></nav><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=posts-heading><h1>Learning Lifetime parameters in Rust: Writing a simple Lisp evaluator</h1><hr class=small></div></div></div></div></div></header><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role=main class=blog-post><p><a href=https://leetcode.com/problems/parse-lisp-expression/>Link to the problem description</a></p><p><strong>Brief description</strong> - We are given a valid Lisp expression. The expression types are</p><ol><li><strong>Integer</strong>: An integer which evaluates to the same value (positive or negative)</li><li><strong>Let</strong>: Used to introduce new variables into the scope</li><li><strong>Add</strong>: <code>(add e1 e2)</code> where <code>e1</code> and <code>e2</code> expressions evaluate to integers. It evaluates to the sum of the two</li><li><strong>Mult</strong>: <code>(mult e1 e2)</code> where <code>e1</code> and <code>e2</code> expressions evaluate to integers. It evaluates to the product of the two</li></ol><p>The problem is to parse, evaluate and return the resulting integer. For instance</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-1>1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-2>2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-3>3</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>(let x 2 
</span></span><span style=display:flex><span>  (mult x (let x 3 y 4 
</span></span><span style=display:flex><span>            (add x y))))
</span></span></code></pre></td></tr></table></div></div><p>evaluates to <code>14</code> as follows</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-1>1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-2>2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-3>3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-4>4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-5>5</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>  (let x 2 (mult x (let x 3 y 4 (add x y))))
</span></span><span style=display:flex><span>= (let x 2 (mult x (let x 3 y 4 (add 3 4)))) -- substitute x=3, y=4
</span></span><span style=display:flex><span>= (let x 2 (mult x 7))                       -- evaluate (add 3 4)
</span></span><span style=display:flex><span>= (let x 2 (mult 2 7))                       -- substitute x=2
</span></span><span style=display:flex><span>= 14                                         -- evaluate (mult 2 7)
</span></span></code></pre></td></tr></table></div></div><p>The solution consists of writing three parts</p><ol><li><strong>Lexer</strong> - tokenizes the input stream</li><li><strong>Evaluator</strong> - builds the <a href=https://en.wikipedia.org/wiki/Abstract_syntax_tree>Abstract Syntax Tree</a> on the fly, walks the tree, maintains <code>Environment</code> containing the value bound for each variable and evaluates the expression. As shown in the example above, the innermost value is considered.</li></ol><p>As one of my main aims was to learn the concepts of borrow and lifetimes, I wrote it to minimize copying as much as possible and keep references to parts of the input stream instead, especially for identifiers. Hence, you will find lifetime specifiers. Please note that zero-copy does not necessarily mean zero-allocations.</p><div class=toc><h2>Contents</h2><nav id=TableOfContents><ul><li><a href=#lexer>Lexer</a><ul><li><a href=#initializing-tokenstream-state>Initializing <code>TokenStream</code> state</a></li><li><a href=#tokenizing-identifier-and-numbers>Tokenizing identifier and numbers</a></li><li><a href=#implementing-iterator-trait-for-tokenstream>Implementing <code>Iterator</code> trait for <code>TokenStream</code></a></li></ul></li><li><a href=#expression-evaluation>Expression evaluation</a><ul><li><a href=#environment>Environment</a></li><li><a href=#expression-evaluation-1>Expression evaluation</a><ul><li><a href=#evaluating-add-and-mult-expressions>Evaluating <code>add</code> and <code>mult</code> expressions</a></li><li><a href=#evaluating-the-let-expression>Evaluating the <code>let</code> expression</a></li></ul></li></ul></li><li><a href=#full-implementation>Full implementation</a></li></ul></nav></div><h2 id=lexer>Lexer</h2><p>Lexer tokenizes the input stream. That is, it classifies different parts of the text according to functions - like numbers, punctuation (open and close parentheses), identifier etc. Lexer turns a stream of bytes (<code>u8</code>) into a stream of <code>Token</code> defined as follows</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-1> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-2> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-3> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-4> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-5> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-6> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-7> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-8> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-9> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-10>10</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-11>11</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-12>12</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-13>13</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-14>14</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-15>15</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-16>16</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-17>17</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-18>18</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-19>19</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#fd8f3f>#[derive(Debug, Eq, PartialEq)]</span>
</span></span><span style=display:flex><span><span style=color:#fc5fa3>enum</span> <span style=color:#5dd8ff>Token</span>&lt;&#39;a&gt; {
</span></span><span style=display:flex><span>    OpenParentheses,
</span></span><span style=display:flex><span>    CloseParentheses,
</span></span><span style=display:flex><span>    Identifier(&amp;&#39;a <span style=color:#fc5fa3>str</span>),
</span></span><span style=display:flex><span>    Number(<span style=color:#fc5fa3>i32</span>),
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fc5fa3>struct</span> <span style=color:#5dd8ff>TokenStream</span>&lt;&#39;b&gt; {
</span></span><span style=display:flex><span>    offset: <span style=color:#fc5fa3>usize</span>,
</span></span><span style=display:flex><span>    s: <span style=color:#fc5fa3>&amp;</span>&#39;b [<span style=color:#fc5fa3>u8</span>],
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fc5fa3>impl</span>&lt;&#39;b&gt; <span style=color:#d0a8ff>Iterator</span> <span style=color:#fc5fa3>for</span> TokenStream&lt;&#39;b&gt; {
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>type</span> <span style=color:#5dd8ff>Item</span> = Token&lt;&#39;b&gt;;
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>fn</span> <span style=color:#41a1c0>next</span>(&amp;<span style=color:#fc5fa3>mut</span> <span style=color:#a167e6>self</span>) -&gt; <span style=color:#d0a8ff>Option</span>&lt;<span style=color:#a167e6>Self</span>::Item&gt; {
</span></span><span style=display:flex><span>        <span style=color:#6c7986>// ... lexer implementation
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>Here the lifetime parameter <code>'b</code> on <code>Token&lt;'b></code> with respect to <code>TokenStream&lt;'b></code> can be read as <strong>&ldquo;The references in <code>Token</code> struct returned by the iterator is valid as long as the underlying reference to <code>s</code> in <code>TokenStream</code> which is a bunch of bytes is also valid&rdquo;</strong>. This byte slice is the input expression. No copying is necessary. In other words, the lifetime parameters say that the references held by the structs are valid as long as the bytes representing the underlying bytes is also valid.</p><p>While reading lifetime parameters, it is helpful to read it with respect to the scope from where references are used (like passing parameters etc). One of the mistakes I used to do was to try to interpret it standalone which didn&rsquo;t make sense at that time.</p><h3 id=initializing-tokenstream-state>Initializing <code>TokenStream</code> state</h3><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-1>1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-2>2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-3>3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-4>4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-5>5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-6>6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-7>7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-8>8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-9>9</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#fc5fa3>impl</span>&lt;&#39;b&gt; TokenStream&lt;&#39;b&gt; {
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>fn</span> <span style=color:#41a1c0>from_string</span>&lt;&#39;a: &#39;b&gt;(s: <span style=color:#fc5fa3>&amp;</span>&#39;a <span style=color:#d0a8ff>String</span>) -&gt; <span style=color:#5dd8ff>TokenStream</span>&lt;&#39;b&gt; {
</span></span><span style=display:flex><span>        TokenStream {
</span></span><span style=display:flex><span>            offset: <span style=color:#d0bf69>0</span>,
</span></span><span style=display:flex><span>            s: <span style=color:#5dd8ff>s</span>.as_bytes(),
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#6c7986>// .. rest of the code
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>}
</span></span></code></pre></td></tr></table></div></div><p>The interesting part for someone learning not to fight the borrow checker is this part</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-1>1</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#fc5fa3>fn</span> <span style=color:#41a1c0>from_string</span>&lt;&#39;a: &#39;b&gt;(s: <span style=color:#fc5fa3>&amp;</span>&#39;a <span style=color:#d0a8ff>String</span>) -&gt; <span style=color:#5dd8ff>TokenStream</span>&lt;&#39;b&gt;
</span></span></code></pre></td></tr></table></div></div><p>There are two lifetime parameters <code>'a</code> and <code>'b</code> with constraints defined on them. <code>s</code> here is the input String. The constraint <code>'a: 'b</code> says that lifetime <code>'a</code> is at least as long as lifetime <code>'b</code>. Here, <code>'a</code> is the lifetime of the input string and <code>'b</code> is the lifetime of the <code>TokenStream</code> iterator built on top of that. The iterator does not consume the data in the sense that it cannot own it. Another reminder - the lifetime parameters, by themselves, are not that useful and would be a nuisance. They only make sense in cases of comparing lifetimes. Here, we are comparing the lifetimes of the input and the stream holding reference to it.</p><p>So the iterator built on top of the immutably borrowed underlying input byte stream should <strong>NOT</strong> live longer than the input itself as this causes <strong>dangling reference</strong> compromising memory safety properties provided by safe Rust. This should cause an error.</p><h3 id=tokenizing-identifier-and-numbers>Tokenizing identifier and numbers</h3><p>The identifier would be a <code>&str</code> which is a reference to the underlying input bytes. Here we assume ASCII and hence all characters would be single byte.</p><p>We advance each byte as long as we find a character that could be part of an identifier (including reserved words like <code>let</code>, <code>add</code>, <code>mult</code>) until we find something else. In this case, it is either a space or open/close parentheses. We note start and end offsets of the identifiers and get <strong>reference</strong> to that part of the input stream. <strong>There is no string copying</strong>.</p><blockquote><p><strong>NOTE</strong>: Internally <code>from_utf8</code> validates if the bytes are UTF-8 encoded and ultimately calls <code>mem::transmute</code> which <strong>re-interprets</strong> those bytes as a different type (very unsafe). As we assume valid expression and ASCII only (which is also valid UTF-8), we can skip the check by calling <code>from_utf8_unchecked</code> which is <strong>unsafe</strong>.</p></blockquote><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-1> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-2> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-3> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-4> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-5> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-6> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-7> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-8> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-9> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-10>10</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-11>11</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-12>12</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-13>13</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-14>14</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-15>15</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-16>16</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-17>17</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-18>18</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-19>19</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-20>20</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-21>21</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-22>22</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-23>23</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#fc5fa3>impl</span>&lt;&#39;b&gt; TokenStream&lt;&#39;b&gt; {
</span></span><span style=display:flex><span>    <span style=color:#6c7986>// .. other code
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>fn</span> <span style=color:#41a1c0>parse_identifier</span>(&amp;<span style=color:#fc5fa3>mut</span> <span style=color:#a167e6>self</span>) -&gt; <span style=color:#fc5fa3>&amp;</span>&#39;b <span style=color:#fc5fa3>str</span> {
</span></span><span style=display:flex><span>        <span style=color:#fc5fa3>let</span> start_offset = <span style=color:#a167e6>self</span>.offset;
</span></span><span style=display:flex><span>        <span style=color:#fc5fa3>while</span> <span style=color:#a167e6>self</span>.offset &lt; <span style=color:#a167e6>self</span>.s.len() {
</span></span><span style=display:flex><span>            <span style=color:#fc5fa3>let</span> cur_byte = <span style=color:#a167e6>self</span>.s[<span style=color:#a167e6>self</span>.offset];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#6c7986>// We don&#39;t check for &#34;starting with digit&#34;
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>            <span style=color:#6c7986>// case as it is already checked by next()
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>            <span style=color:#6c7986>// before entering this method.
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>            <span style=color:#fc5fa3>if</span> cur_byte == <span style=color:#fc6a5d>b&#39;(&#39;</span> || cur_byte == <span style=color:#fc6a5d>b&#39;)&#39;</span> || cur_byte == <span style=color:#fc6a5d>b&#39; &#39;</span> {
</span></span><span style=display:flex><span>                <span style=color:#fc5fa3>break</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#a167e6>self</span>.offset += <span style=color:#d0bf69>1</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        assert!(start_offset &lt; <span style=color:#a167e6>self</span>.offset);
</span></span><span style=display:flex><span>        std::<span style=color:#fc5fa3>str</span>::from_utf8(&amp;<span style=color:#a167e6>self</span>.s[start_offset..<span style=color:#a167e6>self</span>.offset])
</span></span><span style=display:flex><span>            .expect(<span style=color:#fc6a5d>&#34;identifier to be correctly parsed&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6c7986>// .. rest of code
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>}
</span></span></code></pre></td></tr></table></div></div><p>Tokenizing numbers is much simpler (Maybe there is an idiomatic way of writing this. But this is enough for our purposes). Writing this for completeness.</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-1> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-2> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-3> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-4> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-5> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-6> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-7> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-8> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-9> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-10>10</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-11>11</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-12>12</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-13>13</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-14>14</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-15>15</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-16>16</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-17>17</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-18>18</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-19>19</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#fc5fa3>impl</span>&lt;&#39;b&gt; TokenStream&lt;&#39;b&gt; {
</span></span><span style=display:flex><span>    <span style=color:#6c7986>// .. other code
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>fn</span> <span style=color:#41a1c0>parse_number</span>(&amp;<span style=color:#fc5fa3>mut</span> <span style=color:#a167e6>self</span>) -&gt; <span style=color:#fc5fa3>i32</span> {
</span></span><span style=display:flex><span>        <span style=color:#fc5fa3>let</span> <span style=color:#fc5fa3>mut</span> val = <span style=color:#d0bf69>0</span>;
</span></span><span style=display:flex><span>        <span style=color:#fc5fa3>while</span> <span style=color:#a167e6>self</span>.offset &lt; <span style=color:#a167e6>self</span>.s.len() {
</span></span><span style=display:flex><span>            <span style=color:#fc5fa3>let</span> cur_byte = <span style=color:#a167e6>self</span>.s[<span style=color:#a167e6>self</span>.offset];
</span></span><span style=display:flex><span>            <span style=color:#fc5fa3>if</span> cur_byte &lt; <span style=color:#fc6a5d>b&#39;0&#39;</span> || cur_byte &gt; <span style=color:#fc6a5d>b&#39;9&#39;</span> {
</span></span><span style=display:flex><span>                <span style=color:#fc5fa3>break</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#fc5fa3>let</span> cur_digit = (cur_byte - <span style=color:#fc6a5d>b&#39;0&#39;</span>) <span style=color:#fc5fa3>as</span> <span style=color:#fc5fa3>i32</span>;
</span></span><span style=display:flex><span>            val = val * <span style=color:#d0bf69>10</span> + cur_digit;
</span></span><span style=display:flex><span>            <span style=color:#a167e6>self</span>.offset += <span style=color:#d0bf69>1</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        val
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6c7986>// .. rest of code
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=implementing-iterator-trait-for-tokenstream>Implementing <code>Iterator</code> trait for <code>TokenStream</code></h3><p>We can go through the stream at once and eagerly tokenize it into <code>Vec&lt;Token></code>. However, it requires a lot of wasteful allocation. We only need a few tokens to make parsing decisions. So, tokenization is performed lazily. This is implemented by an iterator. Implementing <code>Iterator</code> trait requires implementing <code>next()</code> function which <strong>may</strong> return the next token in the stream.</p><p>We tokenize on the fly from the current input byte offset and return it to the caller as shown below. Notice that there are <strong>no extra heap allocations</strong> (the data part of <code>String</code> is on the heap though. Both the <code>TokenStream</code> and <code>Token::Identifier(&str)</code> reference that piece of memory directly)</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-1> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-2> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-3> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-4> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-5> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-6> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-7> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-8> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-9> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-10>10</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-11>11</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-12>12</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-13>13</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-14>14</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-15>15</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-16>16</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-17>17</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-18>18</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-19>19</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-20>20</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-21>21</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-22>22</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-23>23</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-24>24</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-25>25</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-26>26</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-27>27</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-28>28</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-29>29</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-30>30</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-31>31</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-32>32</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-33>33</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-34>34</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-35>35</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-36>36</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-37>37</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-38>38</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-39>39</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#fc5fa3>impl</span>&lt;&#39;b&gt; <span style=color:#d0a8ff>Iterator</span> <span style=color:#fc5fa3>for</span> TokenStream&lt;&#39;b&gt; {
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>type</span> <span style=color:#5dd8ff>Item</span> = Token&lt;&#39;b&gt;;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>fn</span> <span style=color:#41a1c0>next</span>(&amp;<span style=color:#fc5fa3>mut</span> <span style=color:#a167e6>self</span>) -&gt; <span style=color:#d0a8ff>Option</span>&lt;<span style=color:#a167e6>Self</span>::Item&gt; {
</span></span><span style=display:flex><span>        <span style=color:#fc5fa3>while</span> <span style=color:#a167e6>self</span>.offset &lt; <span style=color:#a167e6>self</span>.s.len() {
</span></span><span style=display:flex><span>            <span style=color:#fc5fa3>let</span> cur_byte = <span style=color:#a167e6>self</span>.s[<span style=color:#a167e6>self</span>.offset];
</span></span><span style=display:flex><span>            <span style=color:#fc5fa3>match</span> cur_byte {
</span></span><span style=display:flex><span>                <span style=color:#fc6a5d>b&#39;(&#39;</span> =&gt; {
</span></span><span style=display:flex><span>                    <span style=color:#a167e6>self</span>.offset += <span style=color:#d0bf69>1</span>;
</span></span><span style=display:flex><span>                    <span style=color:#fc5fa3>return</span> <span style=color:#d0a8ff>Some</span>(Token::OpenParentheses);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#fc6a5d>b&#39;)&#39;</span> =&gt; {
</span></span><span style=display:flex><span>                    <span style=color:#a167e6>self</span>.offset += <span style=color:#d0bf69>1</span>;
</span></span><span style=display:flex><span>                    <span style=color:#fc5fa3>return</span> <span style=color:#d0a8ff>Some</span>(Token::CloseParentheses);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#fc6a5d>b&#39;-&#39;</span> =&gt; {
</span></span><span style=display:flex><span>                    <span style=color:#a167e6>self</span>.offset += <span style=color:#d0bf69>1</span>;
</span></span><span style=display:flex><span>                    <span style=color:#fc5fa3>let</span> num = <span style=color:#a167e6>self</span>.parse_number();
</span></span><span style=display:flex><span>                    <span style=color:#fc5fa3>return</span> <span style=color:#d0a8ff>Some</span>(Token::Number(-num));
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#fc6a5d>b&#39;0&#39;</span>..=<span style=color:#fc6a5d>b&#39;9&#39;</span> =&gt; {
</span></span><span style=display:flex><span>                    <span style=color:#fc5fa3>let</span> num = <span style=color:#a167e6>self</span>.parse_number();
</span></span><span style=display:flex><span>                    <span style=color:#fc5fa3>return</span> <span style=color:#d0a8ff>Some</span>(Token::Number(num));
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#fc6a5d>b&#39;a&#39;</span>..=<span style=color:#fc6a5d>b&#39;z&#39;</span> =&gt; {
</span></span><span style=display:flex><span>                    <span style=color:#fc5fa3>let</span> id = <span style=color:#a167e6>self</span>.parse_identifier();
</span></span><span style=display:flex><span>                    <span style=color:#fc5fa3>return</span> <span style=color:#d0a8ff>Some</span>(Token::Identifier(id));
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#fc6a5d>b&#39; &#39;</span> =&gt; {
</span></span><span style=display:flex><span>                    <span style=color:#a167e6>self</span>.offset += <span style=color:#d0bf69>1</span>;
</span></span><span style=display:flex><span>                    <span style=color:#fc5fa3>continue</span>;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                ch =&gt; panic!(<span style=color:#fc6a5d>&#34;unexpected character: {}&#34;</span>, ch <span style=color:#fc5fa3>as</span> <span style=color:#fc5fa3>char</span>),
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#d0a8ff>None</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=expression-evaluation>Expression evaluation</h2><p>After tokenizing the input stream, it has to be parsed to construct the Abstract Syntax Tree and evaluate. Luckily, Lisp syntax is easy to parse. In this solution, the Abstract Syntax Tree is not constructed explicitly. We take the token stream, parse on the fly, maintain the &ldquo;environment&rdquo; consisting of binding from an identifier to its value and evaluate on the fly.</p><p>The grammar to be parsed is as follows</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-1>1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-2>2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-3>3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-4>4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-5>5</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>&lt;expr&gt; -&gt; (add &lt;expr&gt; &lt;expr&gt;)
</span></span><span style=display:flex><span>        | (mult &lt;expr&gt; &lt;expr&gt;)
</span></span><span style=display:flex><span>        | (let [&lt;ident&gt; &lt;expr&gt;]+ &lt;expr&gt;)
</span></span><span style=display:flex><span>        | &lt;number&gt;
</span></span><span style=display:flex><span>        | &lt;ident&gt;
</span></span></code></pre></td></tr></table></div></div><p>The outline of the evaluator.</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-1> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-2> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-3> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-4> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-5> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-6> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-7> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-8> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-9> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-10>10</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-11>11</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-12>12</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-13>13</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-14>14</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-15>15</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#fc5fa3>struct</span> <span style=color:#5dd8ff>Environment</span>&lt;&#39;a&gt; {
</span></span><span style=display:flex><span>    sym_vals: <span style=color:#d0a8ff>Vec</span>&lt;HashMap&lt;&amp;&#39;a <span style=color:#fc5fa3>str</span>, <span style=color:#fc5fa3>i32</span>&gt;&gt;,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fc5fa3>struct</span> <span style=color:#5dd8ff>LispEvaluator</span>&lt;&#39;b, &#39;a: &#39;b&gt; {
</span></span><span style=display:flex><span>    s: <span style=color:#5dd8ff>std</span>::iter::Peekable&lt;TokenStream&lt;&#39;a&gt;&gt;,
</span></span><span style=display:flex><span>    env: <span style=color:#5dd8ff>Environment</span>&lt;&#39;b&gt;,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fc5fa3>impl</span>&lt;&#39;b, &#39;a&gt; LispEvaluator&lt;&#39;b, &#39;a&gt;
</span></span><span style=display:flex><span><span style=color:#fc5fa3>where</span>
</span></span><span style=display:flex><span>    &#39;a: &#39;b,
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>fn</span> <span style=color:#41a1c0>evaluate</span>(&amp;<span style=color:#fc5fa3>mut</span> <span style=color:#a167e6>self</span>) -&gt; <span style=color:#d0a8ff>Result</span>&lt;<span style=color:#fc5fa3>i32</span>, EvalError&gt;;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>The lifetime variables are interesting here and need some explanation. The <code>Environment</code> needs a lifetime specifier because of the key which is a reference <code>&'a str</code>. The bound <code>'a : 'b</code> says that &ldquo;<code>'a</code> lives at least as long as <code>'b</code>&rdquo; or in other words, <code>'b</code> does not outlive <code>'a</code>.</p><ul><li><code>'a</code> is the lifetime of the underlying input byte stream (remember <code>s: &'b [u8]</code>?).</li><li><code>'b</code> is the lifetime of the identifier key in the hash table wrapped by <code>Environment</code>.</li></ul><p><code>'b</code> does NOT outlive <code>'a</code> would mean that the reference <code>&str</code> added to the HashMap in <code>Environment</code> does not outlive the underlying input byte stream. It makes sense as allowing it would cause dangling reference.</p><h3 id=environment>Environment</h3><p>Environment provides the context for evaluation. It keeps track of the value of bindings, implements shadowing requirements - pick the value of the innermost scope in case the identifier is declared more than once.</p><ul><li>Every <code>let</code> expression creates a scope and when its evaluation is complete, it is destroyed.</li><li>Every binding added through the <code>let</code> expression is added to the innermost scope (let us call it the current scope - the scope that was recently created at the start of evaluating <code>let</code>).</li></ul><p>The operations are straightforward and the implementation is not provided in this section</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-1>1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-2>2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-3>3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-4>4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-5>5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-6>6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-7>7</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#fc5fa3>impl</span>&lt;&#39;a&gt; Environment&lt;&#39;a&gt; {
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>fn</span> <span style=color:#41a1c0>new</span>() -&gt; <span style=color:#5dd8ff>Self</span>;
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>fn</span> <span style=color:#41a1c0>add_binding</span>(&amp;<span style=color:#fc5fa3>mut</span> <span style=color:#a167e6>self</span>, sym: <span style=color:#fc5fa3>&amp;</span>&#39;a <span style=color:#fc5fa3>str</span>, val: <span style=color:#fc5fa3>i32</span>);
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>fn</span> <span style=color:#41a1c0>lookup_symbol</span>(&amp;<span style=color:#a167e6>self</span>, sym: <span style=color:#fc5fa3>&amp;</span>&#39;a <span style=color:#fc5fa3>str</span>) -&gt; <span style=color:#d0a8ff>Option</span>&lt;<span style=color:#fc5fa3>i32</span>&gt;;
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>fn</span> <span style=color:#41a1c0>create_scope</span>(&amp;<span style=color:#fc5fa3>mut</span> <span style=color:#a167e6>self</span>);
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>fn</span> <span style=color:#41a1c0>destroy_scope</span>(&amp;<span style=color:#fc5fa3>mut</span> <span style=color:#a167e6>self</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>The lifetime parameters on methods <code>add_binding</code> and <code>lookup_symbol</code> need some explanation. <code>'a</code> here specifies the constraint that the <code>sym</code> lives at least as long as the structure itself (or the Environment structure does not outlive the passed-in reference).</p><h3 id=expression-evaluation-1>Expression evaluation</h3><p>As mentioned earlier, the token is obtained from <code>TokenStream</code> which <strong>lazily</strong> tokenizes the bytes and does NOT make additional copies of the identifier (It is all <code>&str</code>). Parsing is done in a simple top-down manner. The implementation is straightforward. It maps neatly to the grammar specified earlier.</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-1> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-2> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-3> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-4> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-5> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-6> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-7> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-8> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-9> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-10>10</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-11>11</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-12>12</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-13>13</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-14>14</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-15>15</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-16>16</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-17>17</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-18>18</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-19>19</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-20>20</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-21>21</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-22>22</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-23>23</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-24>24</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-25>25</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-26>26</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-27>27</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-28>28</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-29>29</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-30>30</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-31>31</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-32>32</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-33>33</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-34>34</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-35>35</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-36>36</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-37>37</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-38>38</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-39>39</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-40>40</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-41>41</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-42>42</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#fc5fa3>const</span> ADD_FUNC: <span style=color:#fc5fa3>&amp;</span>&#39;<span style=color:#d0a8ff>static</span> <span style=color:#fc5fa3>str</span> = <span style=color:#fc6a5d>&#34;add&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#fc5fa3>const</span> MULTIPLY_FUNC: <span style=color:#fc5fa3>&amp;</span>&#39;<span style=color:#d0a8ff>static</span> <span style=color:#fc5fa3>str</span> = <span style=color:#fc6a5d>&#34;mult&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#fc5fa3>const</span> LET_KEYWORD: <span style=color:#fc5fa3>&amp;</span>&#39;<span style=color:#d0a8ff>static</span> <span style=color:#fc5fa3>str</span> = <span style=color:#fc6a5d>&#34;let&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fc5fa3>impl</span>&lt;&#39;b, &#39;a&gt; LispEvaluator&lt;&#39;b, &#39;a&gt;
</span></span><span style=display:flex><span><span style=color:#fc5fa3>where</span>
</span></span><span style=display:flex><span>    &#39;a: &#39;b,
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#6c7986>// .. rest of code
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>    
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>fn</span> <span style=color:#41a1c0>evaluate</span>(&amp;<span style=color:#fc5fa3>mut</span> <span style=color:#a167e6>self</span>) -&gt; <span style=color:#d0a8ff>Result</span>&lt;<span style=color:#fc5fa3>i32</span>, EvalError&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a167e6>self</span>.evaluate_expr()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>fn</span> <span style=color:#41a1c0>evaluate_expr</span>(&amp;<span style=color:#fc5fa3>mut</span> <span style=color:#a167e6>self</span>) -&gt; <span style=color:#d0a8ff>Result</span>&lt;<span style=color:#fc5fa3>i32</span>, EvalError&gt; {
</span></span><span style=display:flex><span>        <span style=color:#fc5fa3>let</span> first_tok = <span style=color:#a167e6>self</span>.s.next();
</span></span><span style=display:flex><span>        <span style=color:#fc5fa3>match</span> first_tok {
</span></span><span style=display:flex><span>            <span style=color:#d0a8ff>Some</span>(Token::OpenParentheses) =&gt; {
</span></span><span style=display:flex><span>                <span style=color:#fc5fa3>let</span> second_tok = <span style=color:#a167e6>self</span>.s.next();
</span></span><span style=display:flex><span>                <span style=color:#fc5fa3>let</span> val = <span style=color:#fc5fa3>match</span> second_tok {
</span></span><span style=display:flex><span>                    <span style=color:#d0a8ff>Some</span>(Token::Identifier(ADD_FUNC)) =&gt; <span style=color:#a167e6>self</span>.evaluate_addition(),
</span></span><span style=display:flex><span>                    <span style=color:#d0a8ff>Some</span>(Token::Identifier(MULTIPLY_FUNC)) =&gt; <span style=color:#a167e6>self</span>.evaluate_multiplication(),
</span></span><span style=display:flex><span>                    <span style=color:#d0a8ff>Some</span>(Token::Identifier(LET_KEYWORD)) =&gt; <span style=color:#a167e6>self</span>.evaluate_let_block(),
</span></span><span style=display:flex><span>                    <span style=color:#d0a8ff>Some</span>(tok) =&gt; <span style=color:#d0a8ff>Err</span>(EvalError(format!(
</span></span><span style=display:flex><span>                        <span style=color:#fc6a5d>&#34;unknown token: {:?}, expected add,mult,let&#34;</span>,
</span></span><span style=display:flex><span>                        tok
</span></span><span style=display:flex><span>                    ))),
</span></span><span style=display:flex><span>                    <span style=color:#d0a8ff>None</span> =&gt; <span style=color:#d0a8ff>Err</span>(EvalError(format!(<span style=color:#fc6a5d>&#34;expected add,mult,let, but got nothing&#34;</span>))),
</span></span><span style=display:flex><span>                };
</span></span><span style=display:flex><span>                <span style=color:#a167e6>self</span>.ensure_closing_parentheses().and(val)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#d0a8ff>Some</span>(Token::Identifier(ident)) =&gt; <span style=color:#a167e6>self</span>.evaluate_identifier(ident),
</span></span><span style=display:flex><span>            <span style=color:#d0a8ff>Some</span>(Token::Number(n)) =&gt; <span style=color:#d0a8ff>Ok</span>(n),
</span></span><span style=display:flex><span>            <span style=color:#d0a8ff>Some</span>(tok) =&gt; <span style=color:#d0a8ff>Err</span>(EvalError(format!(<span style=color:#fc6a5d>&#34;unexpected token: {:?}&#34;</span>, tok))),
</span></span><span style=display:flex><span>            <span style=color:#d0a8ff>None</span> =&gt; <span style=color:#d0a8ff>Err</span>(EvalError(format!(
</span></span><span style=display:flex><span>                <span style=color:#fc6a5d>&#34;no token found for evaluating expression&#34;</span>
</span></span><span style=display:flex><span>            ))),
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6c7986>// .. rest of code
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>}
</span></span></code></pre></td></tr></table></div></div><h4 id=evaluating-add-and-mult-expressions>Evaluating <code>add</code> and <code>mult</code> expressions</h4><p>The <code>evaluate_*</code> are a set of mutually recursive functions. The functions <code>evaluate_addition</code> and <code>evaluate_multiplication</code> are straightforward. They parse the expressions representing operands and perform respective operations.</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-1> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-2> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-3> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-4> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-5> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-6> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-7> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-8> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-9> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-10>10</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-11>11</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-12>12</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-13>13</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-14>14</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-15>15</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-16>16</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-17>17</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-18>18</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-19>19</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-20>20</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#fc5fa3>impl</span>&lt;&#39;b, &#39;a&gt; LispEvaluator&lt;&#39;b, &#39;a&gt;
</span></span><span style=display:flex><span><span style=color:#fc5fa3>where</span>
</span></span><span style=display:flex><span>    &#39;a: &#39;b,
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#6c7986>// .. rest of code
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>fn</span> <span style=color:#41a1c0>evaluate_addition</span>(&amp;<span style=color:#fc5fa3>mut</span> <span style=color:#a167e6>self</span>) -&gt; <span style=color:#d0a8ff>Result</span>&lt;<span style=color:#fc5fa3>i32</span>, EvalError&gt; {
</span></span><span style=display:flex><span>        <span style=color:#fc5fa3>let</span> left_val = <span style=color:#a167e6>self</span>.evaluate()?;
</span></span><span style=display:flex><span>        <span style=color:#fc5fa3>let</span> right_val = <span style=color:#a167e6>self</span>.evaluate()?;
</span></span><span style=display:flex><span>        <span style=color:#d0a8ff>Ok</span>(left_val + right_val)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>fn</span> <span style=color:#41a1c0>evaluate_multiplication</span>(&amp;<span style=color:#fc5fa3>mut</span> <span style=color:#a167e6>self</span>) -&gt; <span style=color:#d0a8ff>Result</span>&lt;<span style=color:#fc5fa3>i32</span>, EvalError&gt; {
</span></span><span style=display:flex><span>        <span style=color:#fc5fa3>let</span> left_val = <span style=color:#a167e6>self</span>.evaluate()?;
</span></span><span style=display:flex><span>        <span style=color:#fc5fa3>let</span> right_val = <span style=color:#a167e6>self</span>.evaluate()?;
</span></span><span style=display:flex><span>        <span style=color:#d0a8ff>Ok</span>(left_val * right_val)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6c7986>// .. rest of code
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>}
</span></span></code></pre></td></tr></table></div></div><h4 id=evaluating-the-let-expression>Evaluating the <code>let</code> expression</h4><p>This is a bit more complex than <code>add</code> and <code>mult</code> expressions. Hence, the code is annotated with many comments.</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-1> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-2> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-3> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-4> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-5> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-6> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-7> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-8> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-9> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-10>10</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-11>11</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-12>12</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-13>13</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-14>14</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-15>15</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-16>16</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-17>17</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-18>18</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-19>19</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-20>20</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-21>21</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-22>22</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-23>23</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-24>24</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-25>25</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-26>26</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-27>27</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-28>28</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-29>29</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-30>30</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-31>31</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-32>32</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-33>33</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-34>34</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-35>35</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-36>36</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-37>37</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-38>38</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-39>39</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-40>40</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-41>41</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-42>42</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-43>43</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-44>44</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-45>45</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-46>46</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-47>47</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-48>48</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-49>49</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-50>50</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-51>51</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-52><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-52>52</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-53><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-53>53</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-54><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-54>54</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-55><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-55>55</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-56><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-56>56</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-57><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-57>57</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-58><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-58>58</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-59><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-59>59</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-60><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-60>60</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#fc5fa3>impl</span>&lt;&#39;b, &#39;a&gt; LispEvaluator&lt;&#39;b, &#39;a&gt;
</span></span><span style=display:flex><span><span style=color:#fc5fa3>where</span>
</span></span><span style=display:flex><span>    &#39;a: &#39;b,
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#6c7986>// .. rest of code
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>fn</span> <span style=color:#41a1c0>evaluate_let_block</span>(&amp;<span style=color:#fc5fa3>mut</span> <span style=color:#a167e6>self</span>) -&gt; <span style=color:#d0a8ff>Result</span>&lt;<span style=color:#fc5fa3>i32</span>, EvalError&gt; {
</span></span><span style=display:flex><span>        <span style=color:#6c7986>// The first one would be an identifier and the second
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>        <span style=color:#6c7986>// one would be an expression. The last one would be an
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>        <span style=color:#6c7986>// expression followed by closing parentheses. An identifier
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>        <span style=color:#6c7986>// is also a valid expression and hence that works.
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>        <span style=color:#a167e6>self</span>.env.create_scope();
</span></span><span style=display:flex><span>        <span style=color:#fc5fa3>let</span> expr_result;
</span></span><span style=display:flex><span>        <span style=color:#fc5fa3>loop</span> {
</span></span><span style=display:flex><span>            <span style=color:#fc5fa3>let</span> ident_tok = <span style=color:#a167e6>self</span>.s.peek();
</span></span><span style=display:flex><span>            <span style=color:#fc5fa3>match</span> ident_tok {
</span></span><span style=display:flex><span>                <span style=color:#d0a8ff>Some</span>(&amp;Token::Identifier(ident)) =&gt; {
</span></span><span style=display:flex><span>                    <span style=color:#a167e6>self</span>.s.next();
</span></span><span style=display:flex><span>                    <span style=color:#fc5fa3>let</span> next_tok = <span style=color:#a167e6>self</span>.s.peek();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#6c7986>// If it is an identifier followed by closing parentheses
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>                    <span style=color:#6c7986>// then this should be treated as an expression and should
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>                    <span style=color:#6c7986>// be evaluated as such. If it not a closing parentheses,
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>                    <span style=color:#6c7986>// then it should be evaluated as an expression and should
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>                    <span style=color:#6c7986>// be added to the environment.
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>                    <span style=color:#fc5fa3>if</span> next_tok == <span style=color:#d0a8ff>Some</span>(&amp;Token::CloseParentheses) {
</span></span><span style=display:flex><span>                        expr_result = <span style=color:#a167e6>self</span>.evaluate_identifier(ident);
</span></span><span style=display:flex><span>                        <span style=color:#fc5fa3>break</span>;
</span></span><span style=display:flex><span>                    } <span style=color:#fc5fa3>else</span> {
</span></span><span style=display:flex><span>                        <span style=color:#fc5fa3>let</span> expr_val = <span style=color:#a167e6>self</span>.evaluate_expr()?;
</span></span><span style=display:flex><span>                        <span style=color:#a167e6>self</span>.env.add_binding(ident, expr_val);
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#d0a8ff>Some</span>(_) =&gt; {
</span></span><span style=display:flex><span>                    <span style=color:#6c7986>// If there is something else in a position where identifier
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>                    <span style=color:#6c7986>// is expected, then this must be an expression evaluated in
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>                    <span style=color:#6c7986>// the context of all the let bindings seen so far.
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>                    expr_result = <span style=color:#a167e6>self</span>.evaluate_expr();
</span></span><span style=display:flex><span>                    <span style=color:#fc5fa3>break</span>;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#d0a8ff>None</span> =&gt; {
</span></span><span style=display:flex><span>                    expr_result = <span style=color:#d0a8ff>Err</span>(EvalError(format!(
</span></span><span style=display:flex><span>                        <span style=color:#fc6a5d>&#34;expected expression at the end of let block&#34;</span>
</span></span><span style=display:flex><span>                    )));
</span></span><span style=display:flex><span>                    <span style=color:#fc5fa3>break</span>;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            };
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a167e6>self</span>.env.destroy_scope();
</span></span><span style=display:flex><span>        expr_result
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>fn</span> <span style=color:#41a1c0>evaluate_identifier</span>(&amp;<span style=color:#fc5fa3>mut</span> <span style=color:#a167e6>self</span>, ident: <span style=color:#fc5fa3>&amp;</span>&#39;a <span style=color:#fc5fa3>str</span>) -&gt; <span style=color:#d0a8ff>Result</span>&lt;<span style=color:#fc5fa3>i32</span>, EvalError&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a167e6>self</span>.env
</span></span><span style=display:flex><span>            .lookup_symbol(ident)
</span></span><span style=display:flex><span>            .ok_or(EvalError(format!(<span style=color:#fc6a5d>&#34;cannot lookup symbol: {}&#34;</span>, ident)))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6c7986>// .. rest of code
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>}
</span></span></code></pre></td></tr></table></div></div><p>I&rsquo;ll leave out the parsing logic as it is not that interesting. Notice that creation (<code>create_scope</code>) and deletion of scope (<code>delete_scope</code>). The <code>add_binding</code> makes sure that if the identifier is already defined in outer scopes (the ones before <code>create_scope</code> was called), then it is shadowed. The <code>destroy_scope</code> method removes this shadowing to restore older values. Hence the following expression correctly evaluates to <code>18</code>, not <code>20</code> or <code>16</code></p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-1>1</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>(let x 10 (add (let x 8 x) x))
</span></span></code></pre></td></tr></table></div></div><p>How does it work?</p><ol><li>When the <code>let</code> is encountered an empty scope is created with <code>create_scope</code>. Let me represent it as <code>[]</code> where the rightmost is the innermost scope.</li><li>When the <code>x 10</code> is evaluated, the scope is updated to <code>[x->10]</code></li><li>When the <code>let</code> part of first operand of <code>add</code> is seen, the scopes look like <code>[x->10][]</code></li><li>Now, <code>x 8</code> updates the bindings as <code>[x->10][x->8]</code></li><li>To evaluate <code>x</code>, <code>evaluate_identifier</code> looks at the <strong>innermost</strong> scope and returns <code>8</code>.</li><li>When we are done evaluating the inner <code>let</code> expression, the <code>destroy_scope</code> destroys the innermost scope and all the bindings that are added to it. So, it looks like <code>[x->10]</code>.</li><li>Now, the second operand <code>x</code> is just an identifier. The value returned by <code>lookup_symbol</code> would be <code>10</code></li><li>Finally <code>(add 8 10)</code> is evaluated to <code>18</code>.</li></ol><h2 id=full-implementation>Full implementation</h2><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=1><a style=outline:none;text-decoration:none;color:inherit href=#1>  1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=2><a style=outline:none;text-decoration:none;color:inherit href=#2>  2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=3><a style=outline:none;text-decoration:none;color:inherit href=#3>  3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=4><a style=outline:none;text-decoration:none;color:inherit href=#4>  4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=5><a style=outline:none;text-decoration:none;color:inherit href=#5>  5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=6><a style=outline:none;text-decoration:none;color:inherit href=#6>  6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=7><a style=outline:none;text-decoration:none;color:inherit href=#7>  7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=8><a style=outline:none;text-decoration:none;color:inherit href=#8>  8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=9><a style=outline:none;text-decoration:none;color:inherit href=#9>  9</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=10><a style=outline:none;text-decoration:none;color:inherit href=#10> 10</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=11><a style=outline:none;text-decoration:none;color:inherit href=#11> 11</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=12><a style=outline:none;text-decoration:none;color:inherit href=#12> 12</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=13><a style=outline:none;text-decoration:none;color:inherit href=#13> 13</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=14><a style=outline:none;text-decoration:none;color:inherit href=#14> 14</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=15><a style=outline:none;text-decoration:none;color:inherit href=#15> 15</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=16><a style=outline:none;text-decoration:none;color:inherit href=#16> 16</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=17><a style=outline:none;text-decoration:none;color:inherit href=#17> 17</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=18><a style=outline:none;text-decoration:none;color:inherit href=#18> 18</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=19><a style=outline:none;text-decoration:none;color:inherit href=#19> 19</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=20><a style=outline:none;text-decoration:none;color:inherit href=#20> 20</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=21><a style=outline:none;text-decoration:none;color:inherit href=#21> 21</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=22><a style=outline:none;text-decoration:none;color:inherit href=#22> 22</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=23><a style=outline:none;text-decoration:none;color:inherit href=#23> 23</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=24><a style=outline:none;text-decoration:none;color:inherit href=#24> 24</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=25><a style=outline:none;text-decoration:none;color:inherit href=#25> 25</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=26><a style=outline:none;text-decoration:none;color:inherit href=#26> 26</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=27><a style=outline:none;text-decoration:none;color:inherit href=#27> 27</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=28><a style=outline:none;text-decoration:none;color:inherit href=#28> 28</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=29><a style=outline:none;text-decoration:none;color:inherit href=#29> 29</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=30><a style=outline:none;text-decoration:none;color:inherit href=#30> 30</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=31><a style=outline:none;text-decoration:none;color:inherit href=#31> 31</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=32><a style=outline:none;text-decoration:none;color:inherit href=#32> 32</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=33><a style=outline:none;text-decoration:none;color:inherit href=#33> 33</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=34><a style=outline:none;text-decoration:none;color:inherit href=#34> 34</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=35><a style=outline:none;text-decoration:none;color:inherit href=#35> 35</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=36><a style=outline:none;text-decoration:none;color:inherit href=#36> 36</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=37><a style=outline:none;text-decoration:none;color:inherit href=#37> 37</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=38><a style=outline:none;text-decoration:none;color:inherit href=#38> 38</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=39><a style=outline:none;text-decoration:none;color:inherit href=#39> 39</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=40><a style=outline:none;text-decoration:none;color:inherit href=#40> 40</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=41><a style=outline:none;text-decoration:none;color:inherit href=#41> 41</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=42><a style=outline:none;text-decoration:none;color:inherit href=#42> 42</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=43><a style=outline:none;text-decoration:none;color:inherit href=#43> 43</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=44><a style=outline:none;text-decoration:none;color:inherit href=#44> 44</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=45><a style=outline:none;text-decoration:none;color:inherit href=#45> 45</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=46><a style=outline:none;text-decoration:none;color:inherit href=#46> 46</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=47><a style=outline:none;text-decoration:none;color:inherit href=#47> 47</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=48><a style=outline:none;text-decoration:none;color:inherit href=#48> 48</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=49><a style=outline:none;text-decoration:none;color:inherit href=#49> 49</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=50><a style=outline:none;text-decoration:none;color:inherit href=#50> 50</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=51><a style=outline:none;text-decoration:none;color:inherit href=#51> 51</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=52><a style=outline:none;text-decoration:none;color:inherit href=#52> 52</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=53><a style=outline:none;text-decoration:none;color:inherit href=#53> 53</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=54><a style=outline:none;text-decoration:none;color:inherit href=#54> 54</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=55><a style=outline:none;text-decoration:none;color:inherit href=#55> 55</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=56><a style=outline:none;text-decoration:none;color:inherit href=#56> 56</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=57><a style=outline:none;text-decoration:none;color:inherit href=#57> 57</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=58><a style=outline:none;text-decoration:none;color:inherit href=#58> 58</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=59><a style=outline:none;text-decoration:none;color:inherit href=#59> 59</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=60><a style=outline:none;text-decoration:none;color:inherit href=#60> 60</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=61><a style=outline:none;text-decoration:none;color:inherit href=#61> 61</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=62><a style=outline:none;text-decoration:none;color:inherit href=#62> 62</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=63><a style=outline:none;text-decoration:none;color:inherit href=#63> 63</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=64><a style=outline:none;text-decoration:none;color:inherit href=#64> 64</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=65><a style=outline:none;text-decoration:none;color:inherit href=#65> 65</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=66><a style=outline:none;text-decoration:none;color:inherit href=#66> 66</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=67><a style=outline:none;text-decoration:none;color:inherit href=#67> 67</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=68><a style=outline:none;text-decoration:none;color:inherit href=#68> 68</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=69><a style=outline:none;text-decoration:none;color:inherit href=#69> 69</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=70><a style=outline:none;text-decoration:none;color:inherit href=#70> 70</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=71><a style=outline:none;text-decoration:none;color:inherit href=#71> 71</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=72><a style=outline:none;text-decoration:none;color:inherit href=#72> 72</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=73><a style=outline:none;text-decoration:none;color:inherit href=#73> 73</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=74><a style=outline:none;text-decoration:none;color:inherit href=#74> 74</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=75><a style=outline:none;text-decoration:none;color:inherit href=#75> 75</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=76><a style=outline:none;text-decoration:none;color:inherit href=#76> 76</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=77><a style=outline:none;text-decoration:none;color:inherit href=#77> 77</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=78><a style=outline:none;text-decoration:none;color:inherit href=#78> 78</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=79><a style=outline:none;text-decoration:none;color:inherit href=#79> 79</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=80><a style=outline:none;text-decoration:none;color:inherit href=#80> 80</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=81><a style=outline:none;text-decoration:none;color:inherit href=#81> 81</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=82><a style=outline:none;text-decoration:none;color:inherit href=#82> 82</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=83><a style=outline:none;text-decoration:none;color:inherit href=#83> 83</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=84><a style=outline:none;text-decoration:none;color:inherit href=#84> 84</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=85><a style=outline:none;text-decoration:none;color:inherit href=#85> 85</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=86><a style=outline:none;text-decoration:none;color:inherit href=#86> 86</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=87><a style=outline:none;text-decoration:none;color:inherit href=#87> 87</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=88><a style=outline:none;text-decoration:none;color:inherit href=#88> 88</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=89><a style=outline:none;text-decoration:none;color:inherit href=#89> 89</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=90><a style=outline:none;text-decoration:none;color:inherit href=#90> 90</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=91><a style=outline:none;text-decoration:none;color:inherit href=#91> 91</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=92><a style=outline:none;text-decoration:none;color:inherit href=#92> 92</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=93><a style=outline:none;text-decoration:none;color:inherit href=#93> 93</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=94><a style=outline:none;text-decoration:none;color:inherit href=#94> 94</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=95><a style=outline:none;text-decoration:none;color:inherit href=#95> 95</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=96><a style=outline:none;text-decoration:none;color:inherit href=#96> 96</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=97><a style=outline:none;text-decoration:none;color:inherit href=#97> 97</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=98><a style=outline:none;text-decoration:none;color:inherit href=#98> 98</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=99><a style=outline:none;text-decoration:none;color:inherit href=#99> 99</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=100><a style=outline:none;text-decoration:none;color:inherit href=#100>100</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=101><a style=outline:none;text-decoration:none;color:inherit href=#101>101</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=102><a style=outline:none;text-decoration:none;color:inherit href=#102>102</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=103><a style=outline:none;text-decoration:none;color:inherit href=#103>103</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=104><a style=outline:none;text-decoration:none;color:inherit href=#104>104</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=105><a style=outline:none;text-decoration:none;color:inherit href=#105>105</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=106><a style=outline:none;text-decoration:none;color:inherit href=#106>106</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=107><a style=outline:none;text-decoration:none;color:inherit href=#107>107</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=108><a style=outline:none;text-decoration:none;color:inherit href=#108>108</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=109><a style=outline:none;text-decoration:none;color:inherit href=#109>109</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=110><a style=outline:none;text-decoration:none;color:inherit href=#110>110</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=111><a style=outline:none;text-decoration:none;color:inherit href=#111>111</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=112><a style=outline:none;text-decoration:none;color:inherit href=#112>112</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=113><a style=outline:none;text-decoration:none;color:inherit href=#113>113</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=114><a style=outline:none;text-decoration:none;color:inherit href=#114>114</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=115><a style=outline:none;text-decoration:none;color:inherit href=#115>115</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=116><a style=outline:none;text-decoration:none;color:inherit href=#116>116</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=117><a style=outline:none;text-decoration:none;color:inherit href=#117>117</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=118><a style=outline:none;text-decoration:none;color:inherit href=#118>118</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=119><a style=outline:none;text-decoration:none;color:inherit href=#119>119</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=120><a style=outline:none;text-decoration:none;color:inherit href=#120>120</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=121><a style=outline:none;text-decoration:none;color:inherit href=#121>121</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=122><a style=outline:none;text-decoration:none;color:inherit href=#122>122</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=123><a style=outline:none;text-decoration:none;color:inherit href=#123>123</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=124><a style=outline:none;text-decoration:none;color:inherit href=#124>124</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=125><a style=outline:none;text-decoration:none;color:inherit href=#125>125</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=126><a style=outline:none;text-decoration:none;color:inherit href=#126>126</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=127><a style=outline:none;text-decoration:none;color:inherit href=#127>127</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=128><a style=outline:none;text-decoration:none;color:inherit href=#128>128</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=129><a style=outline:none;text-decoration:none;color:inherit href=#129>129</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=130><a style=outline:none;text-decoration:none;color:inherit href=#130>130</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=131><a style=outline:none;text-decoration:none;color:inherit href=#131>131</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=132><a style=outline:none;text-decoration:none;color:inherit href=#132>132</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=133><a style=outline:none;text-decoration:none;color:inherit href=#133>133</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=134><a style=outline:none;text-decoration:none;color:inherit href=#134>134</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=135><a style=outline:none;text-decoration:none;color:inherit href=#135>135</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=136><a style=outline:none;text-decoration:none;color:inherit href=#136>136</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=137><a style=outline:none;text-decoration:none;color:inherit href=#137>137</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=138><a style=outline:none;text-decoration:none;color:inherit href=#138>138</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=139><a style=outline:none;text-decoration:none;color:inherit href=#139>139</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=140><a style=outline:none;text-decoration:none;color:inherit href=#140>140</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=141><a style=outline:none;text-decoration:none;color:inherit href=#141>141</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=142><a style=outline:none;text-decoration:none;color:inherit href=#142>142</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=143><a style=outline:none;text-decoration:none;color:inherit href=#143>143</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=144><a style=outline:none;text-decoration:none;color:inherit href=#144>144</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=145><a style=outline:none;text-decoration:none;color:inherit href=#145>145</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=146><a style=outline:none;text-decoration:none;color:inherit href=#146>146</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=147><a style=outline:none;text-decoration:none;color:inherit href=#147>147</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=148><a style=outline:none;text-decoration:none;color:inherit href=#148>148</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=149><a style=outline:none;text-decoration:none;color:inherit href=#149>149</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=150><a style=outline:none;text-decoration:none;color:inherit href=#150>150</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=151><a style=outline:none;text-decoration:none;color:inherit href=#151>151</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=152><a style=outline:none;text-decoration:none;color:inherit href=#152>152</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=153><a style=outline:none;text-decoration:none;color:inherit href=#153>153</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=154><a style=outline:none;text-decoration:none;color:inherit href=#154>154</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=155><a style=outline:none;text-decoration:none;color:inherit href=#155>155</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=156><a style=outline:none;text-decoration:none;color:inherit href=#156>156</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=157><a style=outline:none;text-decoration:none;color:inherit href=#157>157</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=158><a style=outline:none;text-decoration:none;color:inherit href=#158>158</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=159><a style=outline:none;text-decoration:none;color:inherit href=#159>159</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=160><a style=outline:none;text-decoration:none;color:inherit href=#160>160</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=161><a style=outline:none;text-decoration:none;color:inherit href=#161>161</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=162><a style=outline:none;text-decoration:none;color:inherit href=#162>162</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=163><a style=outline:none;text-decoration:none;color:inherit href=#163>163</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=164><a style=outline:none;text-decoration:none;color:inherit href=#164>164</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=165><a style=outline:none;text-decoration:none;color:inherit href=#165>165</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=166><a style=outline:none;text-decoration:none;color:inherit href=#166>166</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=167><a style=outline:none;text-decoration:none;color:inherit href=#167>167</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=168><a style=outline:none;text-decoration:none;color:inherit href=#168>168</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=169><a style=outline:none;text-decoration:none;color:inherit href=#169>169</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=170><a style=outline:none;text-decoration:none;color:inherit href=#170>170</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=171><a style=outline:none;text-decoration:none;color:inherit href=#171>171</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=172><a style=outline:none;text-decoration:none;color:inherit href=#172>172</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=173><a style=outline:none;text-decoration:none;color:inherit href=#173>173</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=174><a style=outline:none;text-decoration:none;color:inherit href=#174>174</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=175><a style=outline:none;text-decoration:none;color:inherit href=#175>175</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=176><a style=outline:none;text-decoration:none;color:inherit href=#176>176</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=177><a style=outline:none;text-decoration:none;color:inherit href=#177>177</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=178><a style=outline:none;text-decoration:none;color:inherit href=#178>178</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=179><a style=outline:none;text-decoration:none;color:inherit href=#179>179</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=180><a style=outline:none;text-decoration:none;color:inherit href=#180>180</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=181><a style=outline:none;text-decoration:none;color:inherit href=#181>181</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=182><a style=outline:none;text-decoration:none;color:inherit href=#182>182</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=183><a style=outline:none;text-decoration:none;color:inherit href=#183>183</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=184><a style=outline:none;text-decoration:none;color:inherit href=#184>184</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=185><a style=outline:none;text-decoration:none;color:inherit href=#185>185</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=186><a style=outline:none;text-decoration:none;color:inherit href=#186>186</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=187><a style=outline:none;text-decoration:none;color:inherit href=#187>187</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=188><a style=outline:none;text-decoration:none;color:inherit href=#188>188</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=189><a style=outline:none;text-decoration:none;color:inherit href=#189>189</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=190><a style=outline:none;text-decoration:none;color:inherit href=#190>190</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=191><a style=outline:none;text-decoration:none;color:inherit href=#191>191</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=192><a style=outline:none;text-decoration:none;color:inherit href=#192>192</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=193><a style=outline:none;text-decoration:none;color:inherit href=#193>193</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=194><a style=outline:none;text-decoration:none;color:inherit href=#194>194</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=195><a style=outline:none;text-decoration:none;color:inherit href=#195>195</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=196><a style=outline:none;text-decoration:none;color:inherit href=#196>196</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=197><a style=outline:none;text-decoration:none;color:inherit href=#197>197</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=198><a style=outline:none;text-decoration:none;color:inherit href=#198>198</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=199><a style=outline:none;text-decoration:none;color:inherit href=#199>199</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=200><a style=outline:none;text-decoration:none;color:inherit href=#200>200</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=201><a style=outline:none;text-decoration:none;color:inherit href=#201>201</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=202><a style=outline:none;text-decoration:none;color:inherit href=#202>202</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=203><a style=outline:none;text-decoration:none;color:inherit href=#203>203</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=204><a style=outline:none;text-decoration:none;color:inherit href=#204>204</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=205><a style=outline:none;text-decoration:none;color:inherit href=#205>205</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=206><a style=outline:none;text-decoration:none;color:inherit href=#206>206</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=207><a style=outline:none;text-decoration:none;color:inherit href=#207>207</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=208><a style=outline:none;text-decoration:none;color:inherit href=#208>208</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=209><a style=outline:none;text-decoration:none;color:inherit href=#209>209</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=210><a style=outline:none;text-decoration:none;color:inherit href=#210>210</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=211><a style=outline:none;text-decoration:none;color:inherit href=#211>211</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=212><a style=outline:none;text-decoration:none;color:inherit href=#212>212</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=213><a style=outline:none;text-decoration:none;color:inherit href=#213>213</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=214><a style=outline:none;text-decoration:none;color:inherit href=#214>214</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=215><a style=outline:none;text-decoration:none;color:inherit href=#215>215</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=216><a style=outline:none;text-decoration:none;color:inherit href=#216>216</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=217><a style=outline:none;text-decoration:none;color:inherit href=#217>217</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=218><a style=outline:none;text-decoration:none;color:inherit href=#218>218</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=219><a style=outline:none;text-decoration:none;color:inherit href=#219>219</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=220><a style=outline:none;text-decoration:none;color:inherit href=#220>220</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=221><a style=outline:none;text-decoration:none;color:inherit href=#221>221</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=222><a style=outline:none;text-decoration:none;color:inherit href=#222>222</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=223><a style=outline:none;text-decoration:none;color:inherit href=#223>223</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=224><a style=outline:none;text-decoration:none;color:inherit href=#224>224</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=225><a style=outline:none;text-decoration:none;color:inherit href=#225>225</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=226><a style=outline:none;text-decoration:none;color:inherit href=#226>226</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=227><a style=outline:none;text-decoration:none;color:inherit href=#227>227</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=228><a style=outline:none;text-decoration:none;color:inherit href=#228>228</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=229><a style=outline:none;text-decoration:none;color:inherit href=#229>229</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=230><a style=outline:none;text-decoration:none;color:inherit href=#230>230</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=231><a style=outline:none;text-decoration:none;color:inherit href=#231>231</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=232><a style=outline:none;text-decoration:none;color:inherit href=#232>232</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=233><a style=outline:none;text-decoration:none;color:inherit href=#233>233</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=234><a style=outline:none;text-decoration:none;color:inherit href=#234>234</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=235><a style=outline:none;text-decoration:none;color:inherit href=#235>235</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=236><a style=outline:none;text-decoration:none;color:inherit href=#236>236</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=237><a style=outline:none;text-decoration:none;color:inherit href=#237>237</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=238><a style=outline:none;text-decoration:none;color:inherit href=#238>238</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=239><a style=outline:none;text-decoration:none;color:inherit href=#239>239</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=240><a style=outline:none;text-decoration:none;color:inherit href=#240>240</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=241><a style=outline:none;text-decoration:none;color:inherit href=#241>241</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=242><a style=outline:none;text-decoration:none;color:inherit href=#242>242</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=243><a style=outline:none;text-decoration:none;color:inherit href=#243>243</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=244><a style=outline:none;text-decoration:none;color:inherit href=#244>244</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=245><a style=outline:none;text-decoration:none;color:inherit href=#245>245</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=246><a style=outline:none;text-decoration:none;color:inherit href=#246>246</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=247><a style=outline:none;text-decoration:none;color:inherit href=#247>247</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=248><a style=outline:none;text-decoration:none;color:inherit href=#248>248</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=249><a style=outline:none;text-decoration:none;color:inherit href=#249>249</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=250><a style=outline:none;text-decoration:none;color:inherit href=#250>250</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=251><a style=outline:none;text-decoration:none;color:inherit href=#251>251</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=252><a style=outline:none;text-decoration:none;color:inherit href=#252>252</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=253><a style=outline:none;text-decoration:none;color:inherit href=#253>253</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=254><a style=outline:none;text-decoration:none;color:inherit href=#254>254</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=255><a style=outline:none;text-decoration:none;color:inherit href=#255>255</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=256><a style=outline:none;text-decoration:none;color:inherit href=#256>256</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=257><a style=outline:none;text-decoration:none;color:inherit href=#257>257</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=258><a style=outline:none;text-decoration:none;color:inherit href=#258>258</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=259><a style=outline:none;text-decoration:none;color:inherit href=#259>259</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=260><a style=outline:none;text-decoration:none;color:inherit href=#260>260</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=261><a style=outline:none;text-decoration:none;color:inherit href=#261>261</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=262><a style=outline:none;text-decoration:none;color:inherit href=#262>262</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=263><a style=outline:none;text-decoration:none;color:inherit href=#263>263</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=264><a style=outline:none;text-decoration:none;color:inherit href=#264>264</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=265><a style=outline:none;text-decoration:none;color:inherit href=#265>265</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=266><a style=outline:none;text-decoration:none;color:inherit href=#266>266</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=267><a style=outline:none;text-decoration:none;color:inherit href=#267>267</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=268><a style=outline:none;text-decoration:none;color:inherit href=#268>268</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=269><a style=outline:none;text-decoration:none;color:inherit href=#269>269</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=270><a style=outline:none;text-decoration:none;color:inherit href=#270>270</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=271><a style=outline:none;text-decoration:none;color:inherit href=#271>271</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#fc5fa3>use</span> std::collections::HashMap;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fd8f3f>#[derive(Debug, Eq, PartialEq)]</span>
</span></span><span style=display:flex><span><span style=color:#fc5fa3>enum</span> <span style=color:#5dd8ff>Token</span>&lt;&#39;a&gt; {
</span></span><span style=display:flex><span>    OpenParentheses,
</span></span><span style=display:flex><span>    CloseParentheses,
</span></span><span style=display:flex><span>    Identifier(&amp;&#39;a <span style=color:#fc5fa3>str</span>),
</span></span><span style=display:flex><span>    Number(<span style=color:#fc5fa3>i32</span>),
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fc5fa3>struct</span> <span style=color:#5dd8ff>TokenStream</span>&lt;&#39;b&gt; {
</span></span><span style=display:flex><span>    offset: <span style=color:#fc5fa3>usize</span>,
</span></span><span style=display:flex><span>    s: <span style=color:#fc5fa3>&amp;</span>&#39;b [<span style=color:#fc5fa3>u8</span>],
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fc5fa3>impl</span>&lt;&#39;b&gt; TokenStream&lt;&#39;b&gt; {
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>fn</span> <span style=color:#41a1c0>from_string</span>&lt;&#39;a: &#39;b&gt;(s: <span style=color:#fc5fa3>&amp;</span>&#39;a <span style=color:#d0a8ff>String</span>) -&gt; <span style=color:#5dd8ff>TokenStream</span>&lt;&#39;b&gt; {
</span></span><span style=display:flex><span>        TokenStream {
</span></span><span style=display:flex><span>            offset: <span style=color:#d0bf69>0</span>,
</span></span><span style=display:flex><span>            s: <span style=color:#5dd8ff>s</span>.as_bytes(),
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>fn</span> <span style=color:#41a1c0>parse_number</span>(&amp;<span style=color:#fc5fa3>mut</span> <span style=color:#a167e6>self</span>) -&gt; <span style=color:#fc5fa3>i32</span> {
</span></span><span style=display:flex><span>        <span style=color:#fc5fa3>let</span> <span style=color:#fc5fa3>mut</span> val = <span style=color:#d0bf69>0</span>;
</span></span><span style=display:flex><span>        <span style=color:#fc5fa3>while</span> <span style=color:#a167e6>self</span>.offset &lt; <span style=color:#a167e6>self</span>.s.len() {
</span></span><span style=display:flex><span>            <span style=color:#fc5fa3>let</span> cur_byte = <span style=color:#a167e6>self</span>.s[<span style=color:#a167e6>self</span>.offset];
</span></span><span style=display:flex><span>            <span style=color:#fc5fa3>if</span> cur_byte &lt; <span style=color:#fc6a5d>b&#39;0&#39;</span> || cur_byte &gt; <span style=color:#fc6a5d>b&#39;9&#39;</span> {
</span></span><span style=display:flex><span>                <span style=color:#fc5fa3>break</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#fc5fa3>let</span> cur_digit = (cur_byte - <span style=color:#fc6a5d>b&#39;0&#39;</span>) <span style=color:#fc5fa3>as</span> <span style=color:#fc5fa3>i32</span>;
</span></span><span style=display:flex><span>            val = val * <span style=color:#d0bf69>10</span> + cur_digit;
</span></span><span style=display:flex><span>            <span style=color:#a167e6>self</span>.offset += <span style=color:#d0bf69>1</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        val
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>fn</span> <span style=color:#41a1c0>parse_identifier</span>(&amp;<span style=color:#fc5fa3>mut</span> <span style=color:#a167e6>self</span>) -&gt; <span style=color:#fc5fa3>&amp;</span>&#39;b <span style=color:#fc5fa3>str</span> {
</span></span><span style=display:flex><span>        <span style=color:#fc5fa3>let</span> start_offset = <span style=color:#a167e6>self</span>.offset;
</span></span><span style=display:flex><span>        <span style=color:#fc5fa3>while</span> <span style=color:#a167e6>self</span>.offset &lt; <span style=color:#a167e6>self</span>.s.len() {
</span></span><span style=display:flex><span>            <span style=color:#fc5fa3>let</span> cur_byte = <span style=color:#a167e6>self</span>.s[<span style=color:#a167e6>self</span>.offset];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#6c7986>// We don&#39;t check for &#34;starting with digit&#34;
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>            <span style=color:#6c7986>// case as it is already checked by next()
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>            <span style=color:#6c7986>// before entering this method.
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>            <span style=color:#fc5fa3>if</span> cur_byte == <span style=color:#fc6a5d>b&#39;(&#39;</span> || cur_byte == <span style=color:#fc6a5d>b&#39;)&#39;</span> || cur_byte == <span style=color:#fc6a5d>b&#39; &#39;</span> {
</span></span><span style=display:flex><span>                <span style=color:#fc5fa3>break</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#a167e6>self</span>.offset += <span style=color:#d0bf69>1</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        assert!(start_offset &lt; <span style=color:#a167e6>self</span>.offset);
</span></span><span style=display:flex><span>        std::<span style=color:#fc5fa3>str</span>::from_utf8(&amp;<span style=color:#a167e6>self</span>.s[start_offset..<span style=color:#a167e6>self</span>.offset])
</span></span><span style=display:flex><span>            .expect(<span style=color:#fc6a5d>&#34;identifier to be correctly parsed&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fc5fa3>impl</span>&lt;&#39;b&gt; <span style=color:#d0a8ff>Iterator</span> <span style=color:#fc5fa3>for</span> TokenStream&lt;&#39;b&gt; {
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>type</span> <span style=color:#5dd8ff>Item</span> = Token&lt;&#39;b&gt;;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>fn</span> <span style=color:#41a1c0>next</span>(&amp;<span style=color:#fc5fa3>mut</span> <span style=color:#a167e6>self</span>) -&gt; <span style=color:#d0a8ff>Option</span>&lt;<span style=color:#a167e6>Self</span>::Item&gt; {
</span></span><span style=display:flex><span>        <span style=color:#fc5fa3>while</span> <span style=color:#a167e6>self</span>.offset &lt; <span style=color:#a167e6>self</span>.s.len() {
</span></span><span style=display:flex><span>            <span style=color:#fc5fa3>let</span> cur_byte = <span style=color:#a167e6>self</span>.s[<span style=color:#a167e6>self</span>.offset];
</span></span><span style=display:flex><span>            <span style=color:#fc5fa3>match</span> cur_byte {
</span></span><span style=display:flex><span>                <span style=color:#fc6a5d>b&#39;(&#39;</span> =&gt; {
</span></span><span style=display:flex><span>                    <span style=color:#a167e6>self</span>.offset += <span style=color:#d0bf69>1</span>;
</span></span><span style=display:flex><span>                    <span style=color:#fc5fa3>return</span> <span style=color:#d0a8ff>Some</span>(Token::OpenParentheses);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#fc6a5d>b&#39;)&#39;</span> =&gt; {
</span></span><span style=display:flex><span>                    <span style=color:#a167e6>self</span>.offset += <span style=color:#d0bf69>1</span>;
</span></span><span style=display:flex><span>                    <span style=color:#fc5fa3>return</span> <span style=color:#d0a8ff>Some</span>(Token::CloseParentheses);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#fc6a5d>b&#39;-&#39;</span> =&gt; {
</span></span><span style=display:flex><span>                    <span style=color:#a167e6>self</span>.offset += <span style=color:#d0bf69>1</span>;
</span></span><span style=display:flex><span>                    <span style=color:#fc5fa3>let</span> num = <span style=color:#a167e6>self</span>.parse_number();
</span></span><span style=display:flex><span>                    <span style=color:#fc5fa3>return</span> <span style=color:#d0a8ff>Some</span>(Token::Number(-num));
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#fc6a5d>b&#39;0&#39;</span>..=<span style=color:#fc6a5d>b&#39;9&#39;</span> =&gt; {
</span></span><span style=display:flex><span>                    <span style=color:#fc5fa3>let</span> num = <span style=color:#a167e6>self</span>.parse_number();
</span></span><span style=display:flex><span>                    <span style=color:#fc5fa3>return</span> <span style=color:#d0a8ff>Some</span>(Token::Number(num));
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#fc6a5d>b&#39;a&#39;</span>..=<span style=color:#fc6a5d>b&#39;z&#39;</span> =&gt; {
</span></span><span style=display:flex><span>                    <span style=color:#fc5fa3>let</span> id = <span style=color:#a167e6>self</span>.parse_identifier();
</span></span><span style=display:flex><span>                    <span style=color:#fc5fa3>return</span> <span style=color:#d0a8ff>Some</span>(Token::Identifier(id));
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#fc6a5d>b&#39; &#39;</span> =&gt; {
</span></span><span style=display:flex><span>                    <span style=color:#a167e6>self</span>.offset += <span style=color:#d0bf69>1</span>;
</span></span><span style=display:flex><span>                    <span style=color:#fc5fa3>continue</span>;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                ch =&gt; panic!(<span style=color:#fc6a5d>&#34;unexpected character: {}&#34;</span>, ch <span style=color:#fc5fa3>as</span> <span style=color:#fc5fa3>char</span>),
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#d0a8ff>None</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fc5fa3>struct</span> <span style=color:#5dd8ff>Environment</span>&lt;&#39;a&gt; {
</span></span><span style=display:flex><span>    sym_vals: <span style=color:#d0a8ff>Vec</span>&lt;HashMap&lt;&amp;&#39;a <span style=color:#fc5fa3>str</span>, <span style=color:#fc5fa3>i32</span>&gt;&gt;,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fc5fa3>impl</span>&lt;&#39;a&gt; Environment&lt;&#39;a&gt; {
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>fn</span> <span style=color:#41a1c0>new</span>() -&gt; <span style=color:#5dd8ff>Self</span> {
</span></span><span style=display:flex><span>        Environment { sym_vals: <span style=color:#5dd8ff>vec</span>![] }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>fn</span> <span style=color:#41a1c0>add_binding</span>(&amp;<span style=color:#fc5fa3>mut</span> <span style=color:#a167e6>self</span>, sym: <span style=color:#fc5fa3>&amp;</span>&#39;a <span style=color:#fc5fa3>str</span>, val: <span style=color:#fc5fa3>i32</span>) {
</span></span><span style=display:flex><span>        assert!(!<span style=color:#a167e6>self</span>.sym_vals.is_empty());
</span></span><span style=display:flex><span>        <span style=color:#a167e6>self</span>.sym_vals.last_mut().map(|scope| scope.insert(sym, val));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>fn</span> <span style=color:#41a1c0>lookup_symbol</span>(&amp;<span style=color:#a167e6>self</span>, sym: <span style=color:#fc5fa3>&amp;</span>&#39;a <span style=color:#fc5fa3>str</span>) -&gt; <span style=color:#d0a8ff>Option</span>&lt;<span style=color:#fc5fa3>i32</span>&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a167e6>self</span>.sym_vals
</span></span><span style=display:flex><span>            .iter()
</span></span><span style=display:flex><span>            .rev()
</span></span><span style=display:flex><span>            .find(|&amp;tbl| tbl.contains_key(sym))
</span></span><span style=display:flex><span>            .map(|tbl| *tbl.get(sym).unwrap())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>fn</span> <span style=color:#41a1c0>create_scope</span>(&amp;<span style=color:#fc5fa3>mut</span> <span style=color:#a167e6>self</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a167e6>self</span>.sym_vals.push(HashMap::new());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>fn</span> <span style=color:#41a1c0>destroy_scope</span>(&amp;<span style=color:#fc5fa3>mut</span> <span style=color:#a167e6>self</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a167e6>self</span>.sym_vals.pop();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fc5fa3>struct</span> <span style=color:#5dd8ff>LispEvaluator</span>&lt;&#39;b, &#39;a: &#39;b&gt; {
</span></span><span style=display:flex><span>    s: <span style=color:#5dd8ff>std</span>::iter::Peekable&lt;TokenStream&lt;&#39;a&gt;&gt;,
</span></span><span style=display:flex><span>    env: <span style=color:#5dd8ff>Environment</span>&lt;&#39;b&gt;,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fd8f3f>#[derive(Debug)]</span>
</span></span><span style=display:flex><span><span style=color:#fc5fa3>struct</span> <span style=color:#5dd8ff>EvalError</span>(<span style=color:#d0a8ff>String</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fc5fa3>const</span> ADD_FUNC: <span style=color:#fc5fa3>&amp;</span>&#39;<span style=color:#d0a8ff>static</span> <span style=color:#fc5fa3>str</span> = <span style=color:#fc6a5d>&#34;add&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#fc5fa3>const</span> MULTIPLY_FUNC: <span style=color:#fc5fa3>&amp;</span>&#39;<span style=color:#d0a8ff>static</span> <span style=color:#fc5fa3>str</span> = <span style=color:#fc6a5d>&#34;mult&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#fc5fa3>const</span> LET_KEYWORD: <span style=color:#fc5fa3>&amp;</span>&#39;<span style=color:#d0a8ff>static</span> <span style=color:#fc5fa3>str</span> = <span style=color:#fc6a5d>&#34;let&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fc5fa3>impl</span>&lt;&#39;b, &#39;a&gt; LispEvaluator&lt;&#39;b, &#39;a&gt;
</span></span><span style=display:flex><span><span style=color:#fc5fa3>where</span>
</span></span><span style=display:flex><span>    &#39;a: &#39;b,
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>fn</span> <span style=color:#41a1c0>new</span>(tok_stream: <span style=color:#5dd8ff>TokenStream</span>&lt;&#39;a&gt;) -&gt; <span style=color:#5dd8ff>Self</span> {
</span></span><span style=display:flex><span>        <span style=color:#fc5fa3>let</span> <span style=color:#fc5fa3>mut</span> scope = Environment::new();
</span></span><span style=display:flex><span>        scope.create_scope();
</span></span><span style=display:flex><span>        LispEvaluator {
</span></span><span style=display:flex><span>            s: <span style=color:#5dd8ff>tok_stream</span>.peekable(),
</span></span><span style=display:flex><span>            env: <span style=color:#5dd8ff>scope</span>,
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6c7986>// evaluate evaluates the Lisp expression written
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>    <span style=color:#6c7986>// according to the following grammar
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>    <span style=color:#6c7986>//
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>    <span style=color:#6c7986>// &lt;expr&gt; -&gt; (add &lt;expr&gt; &lt;expr&gt;)
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>    <span style=color:#6c7986>//         | (mult &lt;expr&gt; &lt;expr&gt;)
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>    <span style=color:#6c7986>//         | (let [&lt;ident&gt; &lt;expr&gt;]+ &lt;expr&gt;)
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>    <span style=color:#6c7986>//         | &lt;number&gt;
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>    <span style=color:#6c7986>//         | &lt;ident&gt;
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>    <span style=color:#fc5fa3>fn</span> <span style=color:#41a1c0>evaluate</span>(&amp;<span style=color:#fc5fa3>mut</span> <span style=color:#a167e6>self</span>) -&gt; <span style=color:#d0a8ff>Result</span>&lt;<span style=color:#fc5fa3>i32</span>, EvalError&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a167e6>self</span>.evaluate_expr()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>fn</span> <span style=color:#41a1c0>evaluate_expr</span>(&amp;<span style=color:#fc5fa3>mut</span> <span style=color:#a167e6>self</span>) -&gt; <span style=color:#d0a8ff>Result</span>&lt;<span style=color:#fc5fa3>i32</span>, EvalError&gt; {
</span></span><span style=display:flex><span>        <span style=color:#fc5fa3>let</span> first_tok = <span style=color:#a167e6>self</span>.s.next();
</span></span><span style=display:flex><span>        <span style=color:#fc5fa3>match</span> first_tok {
</span></span><span style=display:flex><span>            <span style=color:#d0a8ff>Some</span>(Token::OpenParentheses) =&gt; {
</span></span><span style=display:flex><span>                <span style=color:#fc5fa3>let</span> second_tok = <span style=color:#a167e6>self</span>.s.next();
</span></span><span style=display:flex><span>                <span style=color:#fc5fa3>let</span> val = <span style=color:#fc5fa3>match</span> second_tok {
</span></span><span style=display:flex><span>                    <span style=color:#d0a8ff>Some</span>(Token::Identifier(ADD_FUNC)) =&gt; <span style=color:#a167e6>self</span>.evaluate_addition(),
</span></span><span style=display:flex><span>                    <span style=color:#d0a8ff>Some</span>(Token::Identifier(MULTIPLY_FUNC)) =&gt; <span style=color:#a167e6>self</span>.evaluate_multiplication(),
</span></span><span style=display:flex><span>                    <span style=color:#d0a8ff>Some</span>(Token::Identifier(LET_KEYWORD)) =&gt; <span style=color:#a167e6>self</span>.evaluate_let_block(),
</span></span><span style=display:flex><span>                    <span style=color:#d0a8ff>Some</span>(tok) =&gt; <span style=color:#d0a8ff>Err</span>(EvalError(format!(
</span></span><span style=display:flex><span>                        <span style=color:#fc6a5d>&#34;unknown token: {:?}, expected add,mult,let&#34;</span>,
</span></span><span style=display:flex><span>                        tok
</span></span><span style=display:flex><span>                    ))),
</span></span><span style=display:flex><span>                    <span style=color:#d0a8ff>None</span> =&gt; <span style=color:#d0a8ff>Err</span>(EvalError(format!(<span style=color:#fc6a5d>&#34;expected add,mult,let, but got nothing&#34;</span>))),
</span></span><span style=display:flex><span>                };
</span></span><span style=display:flex><span>                <span style=color:#a167e6>self</span>.ensure_closing_parentheses().and(val)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#d0a8ff>Some</span>(Token::Identifier(ident)) =&gt; <span style=color:#a167e6>self</span>.evaluate_identifier(ident),
</span></span><span style=display:flex><span>            <span style=color:#d0a8ff>Some</span>(Token::Number(n)) =&gt; <span style=color:#d0a8ff>Ok</span>(n),
</span></span><span style=display:flex><span>            <span style=color:#d0a8ff>Some</span>(tok) =&gt; <span style=color:#d0a8ff>Err</span>(EvalError(format!(<span style=color:#fc6a5d>&#34;unexpected token: {:?}&#34;</span>, tok))),
</span></span><span style=display:flex><span>            <span style=color:#d0a8ff>None</span> =&gt; <span style=color:#d0a8ff>Err</span>(EvalError(format!(
</span></span><span style=display:flex><span>                <span style=color:#fc6a5d>&#34;no token found for evaluating expression&#34;</span>
</span></span><span style=display:flex><span>            ))),
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>fn</span> <span style=color:#41a1c0>evaluate_addition</span>(&amp;<span style=color:#fc5fa3>mut</span> <span style=color:#a167e6>self</span>) -&gt; <span style=color:#d0a8ff>Result</span>&lt;<span style=color:#fc5fa3>i32</span>, EvalError&gt; {
</span></span><span style=display:flex><span>        <span style=color:#fc5fa3>let</span> left_val = <span style=color:#a167e6>self</span>.evaluate()?;
</span></span><span style=display:flex><span>        <span style=color:#fc5fa3>let</span> right_val = <span style=color:#a167e6>self</span>.evaluate()?;
</span></span><span style=display:flex><span>        <span style=color:#d0a8ff>Ok</span>(left_val + right_val)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>fn</span> <span style=color:#41a1c0>evaluate_multiplication</span>(&amp;<span style=color:#fc5fa3>mut</span> <span style=color:#a167e6>self</span>) -&gt; <span style=color:#d0a8ff>Result</span>&lt;<span style=color:#fc5fa3>i32</span>, EvalError&gt; {
</span></span><span style=display:flex><span>        <span style=color:#fc5fa3>let</span> left_val = <span style=color:#a167e6>self</span>.evaluate()?;
</span></span><span style=display:flex><span>        <span style=color:#fc5fa3>let</span> right_val = <span style=color:#a167e6>self</span>.evaluate()?;
</span></span><span style=display:flex><span>        <span style=color:#d0a8ff>Ok</span>(left_val * right_val)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>fn</span> <span style=color:#41a1c0>evaluate_let_block</span>(&amp;<span style=color:#fc5fa3>mut</span> <span style=color:#a167e6>self</span>) -&gt; <span style=color:#d0a8ff>Result</span>&lt;<span style=color:#fc5fa3>i32</span>, EvalError&gt; {
</span></span><span style=display:flex><span>        <span style=color:#6c7986>// The first one would be an identifier and the second
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>        <span style=color:#6c7986>// one would be an expression. The last one would be an
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>        <span style=color:#6c7986>// expression followed by closing parentheses. An identifier
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>        <span style=color:#6c7986>// is also a valid expression and hence that works.
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>        <span style=color:#a167e6>self</span>.env.create_scope();
</span></span><span style=display:flex><span>        <span style=color:#fc5fa3>let</span> expr_result;
</span></span><span style=display:flex><span>        <span style=color:#fc5fa3>loop</span> {
</span></span><span style=display:flex><span>            <span style=color:#fc5fa3>let</span> ident_tok = <span style=color:#a167e6>self</span>.s.peek();
</span></span><span style=display:flex><span>            <span style=color:#fc5fa3>match</span> ident_tok {
</span></span><span style=display:flex><span>                <span style=color:#d0a8ff>Some</span>(&amp;Token::Identifier(ident)) =&gt; {
</span></span><span style=display:flex><span>                    <span style=color:#a167e6>self</span>.s.next();
</span></span><span style=display:flex><span>                    <span style=color:#fc5fa3>let</span> next_tok = <span style=color:#a167e6>self</span>.s.peek();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#6c7986>// If it is an identifier followed by closing parentheses
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>                    <span style=color:#6c7986>// then this should be treated as an expression and should
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>                    <span style=color:#6c7986>// be evaluated as such. If it not a closing parentheses,
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>                    <span style=color:#6c7986>// then it should be evaluated as an expression and should
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>                    <span style=color:#6c7986>// be added to the environment.
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>                    <span style=color:#fc5fa3>if</span> next_tok == <span style=color:#d0a8ff>Some</span>(&amp;Token::CloseParentheses) {
</span></span><span style=display:flex><span>                        expr_result = <span style=color:#a167e6>self</span>.evaluate_identifier(ident);
</span></span><span style=display:flex><span>                        <span style=color:#fc5fa3>break</span>;
</span></span><span style=display:flex><span>                    } <span style=color:#fc5fa3>else</span> {
</span></span><span style=display:flex><span>                        <span style=color:#fc5fa3>let</span> expr_val = <span style=color:#a167e6>self</span>.evaluate_expr()?;
</span></span><span style=display:flex><span>                        <span style=color:#a167e6>self</span>.env.add_binding(ident, expr_val);
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#d0a8ff>Some</span>(_) =&gt; {
</span></span><span style=display:flex><span>                    <span style=color:#6c7986>// If there is something else in a position where identifier
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>                    <span style=color:#6c7986>// is expected, then this must be an expression evaluated in
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>                    <span style=color:#6c7986>// the context of all the let bindings seen so far.
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>                    expr_result = <span style=color:#a167e6>self</span>.evaluate_expr();
</span></span><span style=display:flex><span>                    <span style=color:#fc5fa3>break</span>;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#d0a8ff>None</span> =&gt; {
</span></span><span style=display:flex><span>                    expr_result = <span style=color:#d0a8ff>Err</span>(EvalError(format!(
</span></span><span style=display:flex><span>                        <span style=color:#fc6a5d>&#34;expected expression at the end of let block&#34;</span>
</span></span><span style=display:flex><span>                    )));
</span></span><span style=display:flex><span>                    <span style=color:#fc5fa3>break</span>;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            };
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a167e6>self</span>.env.destroy_scope();
</span></span><span style=display:flex><span>        expr_result
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>fn</span> <span style=color:#41a1c0>evaluate_identifier</span>(&amp;<span style=color:#fc5fa3>mut</span> <span style=color:#a167e6>self</span>, ident: <span style=color:#fc5fa3>&amp;</span>&#39;a <span style=color:#fc5fa3>str</span>) -&gt; <span style=color:#d0a8ff>Result</span>&lt;<span style=color:#fc5fa3>i32</span>, EvalError&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a167e6>self</span>.env
</span></span><span style=display:flex><span>            .lookup_symbol(ident)
</span></span><span style=display:flex><span>            .ok_or(EvalError(format!(<span style=color:#fc6a5d>&#34;cannot lookup symbol: {}&#34;</span>, ident)))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>fn</span> <span style=color:#41a1c0>ensure_closing_parentheses</span>(&amp;<span style=color:#fc5fa3>mut</span> <span style=color:#a167e6>self</span>) -&gt; <span style=color:#d0a8ff>Result</span>&lt;(), EvalError&gt; {
</span></span><span style=display:flex><span>        <span style=color:#fc5fa3>let</span> tok = <span style=color:#a167e6>self</span>.s.next();
</span></span><span style=display:flex><span>        <span style=color:#fc5fa3>if</span> tok == <span style=color:#d0a8ff>Some</span>(Token::CloseParentheses) {
</span></span><span style=display:flex><span>            <span style=color:#d0a8ff>Ok</span>(())
</span></span><span style=display:flex><span>        } <span style=color:#fc5fa3>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#d0a8ff>Err</span>(EvalError(format!(
</span></span><span style=display:flex><span>                <span style=color:#fc6a5d>&#34;expected closing parentheses, got {:?}&#34;</span>,
</span></span><span style=display:flex><span>                tok
</span></span><span style=display:flex><span>            )))
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fc5fa3>fn</span> <span style=color:#41a1c0>evaluate</span>(s: <span style=color:#d0a8ff>String</span>) -&gt; <span style=color:#fc5fa3>i32</span> {
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>let</span> stream = TokenStream::from_string(&amp;s);
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>let</span> <span style=color:#fc5fa3>mut</span> evaluator = LispEvaluator::new(stream);
</span></span><span style=display:flex><span>    evaluator.evaluate().expect(<span style=color:#fc6a5d>&#34;expected i32, but got error&#34;</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></td></tr></table></div></div><div class=blog-tags><a href=https://su225.github.io//tags/leetcode/>leetcode</a>&nbsp;
<a href=https://su225.github.io//tags/rust/>rust</a>&nbsp;
<a href=https://su225.github.io//tags/learning/>learning</a>&nbsp;</div></article><ul class="pager blog-pager"><li class=previous><a href=https://su225.github.io/posts/leetcode-populating-next-right-pointers-in-each-node/ data-toggle=tooltip data-placement=top title="[Leetcode] Populating the next right pointers in each node">&larr; Previous Post</a></li></ul></div></div></div><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href=https://github.com/su225 title=GitHub><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://linkedin.com/in/suchithjn title=LinkedIn><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="credits copyright text-muted">Suchith J N
&nbsp;&bull;&nbsp;&copy;
2022
&nbsp;&bull;&nbsp;
<a href=https://su225.github.io/>Tech notes</a></p><p class="credits theme-by text-muted"><a href=https://gohugo.io>Hugo v0.101.0</a> powered &nbsp;&bull;&nbsp; Theme <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></div></div></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe crossorigin=anonymous></script>
<script src=https://code.jquery.com/jquery-1.12.4.min.js integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin=anonymous></script>
<script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script>
<script src=https://su225.github.io/js/main.js></script><script>renderMathInElement(document.body)</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://su225.github.io/js/load-photoswipe.js></script></body></html>