<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><meta name=description content><title>Supporting HTTP/3 at the ingress gateway in Istio | Suchith's blog
</title><link rel=stylesheet href=/assets/combined.min.f69b4a5b91a9bc416804eda1f19d04210551b843d47318bf1913d7edce1504fb.css media=all></head><body class=light><div class=content><header><div class=header><h1 class=header-title>Suchith's blog</h1><div class=flex><p class=small><a href=/>/home</a></p><p class=small><a href=/posts>/posts</a></p><p class=small><a href=/about>/about</a></p></div></div></header><main class=main><div class=breadcrumbs><a href=/>Home</a>
<span class=breadcrumbs-separator>> </span><a href=/posts/>Posts</a>
<span class=breadcrumbs-separator>> </span><a class=breadcrumbs-current href=/posts/http3-support-in-istio-gateway/>Supporting HTTP/3 at the ingress gateway in Istio</a></div><div><div class=single-intro-container><h1 class=single-title>Supporting HTTP/3 at the ingress gateway in Istio</h1><p class=single-readtime><time datetime=2021-10-23T20:00:17+05:30>October 23, 2021</time></p></div><div class=single-content><p>A few months ago I contributed experimental HTTP/3 support at the Istio ingress gateway
(<a href=https://github.com/istio/istio/pull/33817>PR</a>). For the HTTPS gateway
servers which terminate the TLS at the gateway, it automatically adds a mirror HTTP/3
listener over QUIC provided that there is an open UDP port. If there is an HTTPS server
on TCP port 443, then an HTTP/3 server is automatically created on UDP port 443 as
illustrated in the diagram below. <strong>All you need to do is to flip a switch on pilot and
open UDP ports</strong>.</p><div class=toc><h2>Contents</h2><nav id=TableOfContents><ul><li><a href=#prerequistes>Prerequistes</a><ul><li><a href=#kubernetes>Kubernetes</a></li><li><a href=#curl>cURL</a></li><li><a href=#istio>Istio</a></li></ul></li><li><a href=#setup>Setup</a><ul><li><a href=#setting-up-istio>Setting up Istio</a></li><li><a href=#deploying-httpbin>Deploying httpbin</a></li><li><a href=#setting-up-tls-certificates-for-the-gateway>Setting up TLS certificates for the gateway</a></li><li><a href=#istio-configuration>Istio configuration</a></li></ul></li><li><a href=#demo-time>Demo time</a></li></ul></nav></div><h2 id=prerequistes>Prerequistes</h2><p>HTTP/3 over QUIC is so new as of writing this. QUIC was standardized this May end and HTTP/3 is not yet
standardized (There is an IETF draft <a href=https://datatracker.ietf.org/doc/html/draft-ietf-quic-http-34>here</a>).
So creating custom builds, turning on alpha features are expected. I&rsquo;m running Linux.</p><h3 id=kubernetes>Kubernetes</h3><p>This feature requires the supporting both TCP and UDP on the same port at the gateway. By
default for Kubernetes services of type <code>LoadBalancer</code> this is not allowed. Since Kubernetes
1.20 there is alpha support. As documented <a href=https://kubernetes.io/docs/concepts/services-networking/service/#load-balancers-with-mixed-protocol-types>here</a>, it can be turned on with <code>MixedProtocolLBSupport</code>
feature gate.</p><p>For this demo, I use Kind to provision a cluster with the following config</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:navy>kind</span>:<span style=color:#bbb> </span>Cluster<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:navy>apiVersion</span>:<span style=color:#bbb> </span>kind.x-k8s.io/v1alpha4<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:navy>featureGates</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:navy>MixedProtocolLBService</span>:<span style=color:#bbb> </span><span style=color:#000;font-weight:700>true</span><span style=color:#bbb> </span><span style=color:#998;font-style:italic># Very important</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:navy>kubeadmConfigPatches</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- |<span style=color:#d14>
</span></span></span><span style=display:flex><span><span style=color:#d14>  apiVersion: kubeadm.k8s.io/v1beta2
</span></span></span><span style=display:flex><span><span style=color:#d14>  kind: ClusterConfiguration
</span></span></span><span style=display:flex><span><span style=color:#d14>  metadata:
</span></span></span><span style=display:flex><span><span style=color:#d14>    name: config
</span></span></span><span style=display:flex><span><span style=color:#d14>  apiServer:
</span></span></span><span style=display:flex><span><span style=color:#d14>    extraArgs:
</span></span></span><span style=display:flex><span><span style=color:#d14>      &#34;service-account-issuer&#34;: &#34;kubernetes.default.svc&#34;
</span></span></span><span style=display:flex><span><span style=color:#d14>      &#34;service-account-signing-key-file&#34;: &#34;/etc/kubernetes/pki/sa.key&#34;</span><span style=color:#bbb>  
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:navy>containerdConfigPatches</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- |-<span style=color:#d14>
</span></span></span><span style=display:flex><span><span style=color:#d14>    [plugins.&#34;io.containerd.grpc.v1.cri&#34;.registry.mirrors.&#34;localhost:5000&#34;]
</span></span></span><span style=display:flex><span><span style=color:#d14>      endpoint = [&#34;http://kind-registry:5000&#34;]</span><span style=color:#bbb>    
</span></span></span></code></pre></div><p>For the load balancer support, I&rsquo;m using <a href=https://metallb.universe.tf/>MetalLB</a> with the following configuration.
For setup and usage instructions, please refer to their documentation.</p><h3 id=curl>cURL</h3><p>Testing the setup requires support for <code>--http3</code> flag. If it is not supported out of the box,
then you have to build it with Cloudflare Quiche support as documented <a href=https://github.com/curl/curl/blob/master/docs/HTTP3.md>here</a>.</p><h3 id=istio>Istio</h3><p>As of writing this Istio 1.12 is not yet released. So the pilot and proxy images should be
built from the master branch.</p><h2 id=setup>Setup</h2><p>Demo setup consists of</p><ol><li>Setting up Istio</li><li>Deploying httpbin application</li><li>Setting up gateway TLS certificates</li><li>Configuring ingress gateway</li></ol><p>Here is the demo setup<figure><div><img loading=lazy alt=Setup src=images/setup.png></div></figure></p><h3 id=setting-up-istio>Setting up Istio</h3><p>There are two important things</p><ol><li>Set <code>PILOT_ENABLE_QUIC_LISTENERS</code> environment variable to <code>true</code> on <strong>Istiod</strong> to turn on generating HTTP/3 mirror listener on the gateway</li><li>Exposing both 443/UDP and 443/TCP - <strong>same port, different transport protocol</strong></li></ol><p>Here is an example <code>IstioOperator</code> spec.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:navy>apiVersion</span>:<span style=color:#bbb> </span>install.istio.io/v1alpha1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:navy>kind</span>:<span style=color:#bbb> </span>IstioOperator<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:navy>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:navy>name</span>:<span style=color:#bbb> </span>install<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:navy>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#998;font-style:italic># Replace HUB and TAG to point to your</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#998;font-style:italic># image repository and the custom image tag</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:navy>hub</span>:<span style=color:#bbb> </span>localhost:5000<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:navy>tag</span>:<span style=color:#bbb> </span>master<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:navy>components</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:navy>ingressGateways</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:navy>name</span>:<span style=color:#bbb> </span>istio-ingressgateway<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:navy>enabled</span>:<span style=color:#bbb> </span><span style=color:#000;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:navy>k8s</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:navy>service</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:navy>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>- <span style=color:navy>name</span>:<span style=color:#bbb> </span>status-port<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:navy>port</span>:<span style=color:#bbb> </span><span style=color:#099>15021</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:navy>targetPort</span>:<span style=color:#bbb> </span><span style=color:#099>15021</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:#998;font-style:italic># Both HTTPS and HTTP/3 must have</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:#998;font-style:italic># the same port number. Here it</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:#998;font-style:italic># is 443/TCP and 443/UDP</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>- <span style=color:navy>name</span>:<span style=color:#bbb> </span>https<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:navy>port</span>:<span style=color:#bbb> </span><span style=color:#099>443</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:navy>targetPort</span>:<span style=color:#bbb> </span><span style=color:#099>8443</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span>- <span style=color:navy>name</span>:<span style=color:#bbb> </span>http3<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:navy>port</span>:<span style=color:#bbb> </span><span style=color:#099>443</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:navy>targetPort</span>:<span style=color:#bbb> </span><span style=color:#099>8443</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:navy>protocol</span>:<span style=color:#bbb> </span>UDP<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:navy>values</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:navy>pilot</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#998;font-style:italic># This is required to create mirror QUIC</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#998;font-style:italic># listeners for TLS-terminated HTTPS listeners</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:#998;font-style:italic># on the gateway</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:navy>env</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:navy>PILOT_ENABLE_QUIC_LISTENERS</span>:<span style=color:#bbb> </span><span style=color:#000;font-weight:700>true</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>Then install Istio</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ istioctl install -f istio.yaml -y
</span></span></code></pre></div><h3 id=deploying-httpbin>Deploying httpbin</h3><p>I am using the sample httpbin provided in the main Istio repository (<a href=https://raw.githubusercontent.com/istio/istio/master/samples/httpbin/httpbin.yaml>Link</a>). Deploy it with good old <code>kubectl</code>. Make sure that Istio sidecars are injected.
You can turn on istio sidecar injection at the namespace level by labeling it <code>istio-injection=enabled</code>
or if you are using revisions (please use it to make upgrades smoother), then it is <code>istio.io/rev=&lt;revision-name></code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl create namespace httpbin
</span></span><span style=display:flex><span>$ kubectl label namespace httpbin istio-injection<span style=color:#000;font-weight:700>=</span>enabled
</span></span><span style=display:flex><span>$ kubectl -n httpbin apply -f <span style=color:#d14>\
</span></span></span><span style=display:flex><span><span style=color:#d14></span>  https://raw.githubusercontent.com/istio/istio/master/samples/httpbin/httpbin.yaml
</span></span></code></pre></div><h3 id=setting-up-tls-certificates-for-the-gateway>Setting up TLS certificates for the gateway</h3><p>HTTP/3 is over TLS only. In fact, using TLS is baked into QUIC, the underlying transport protocol
as described in <a href=https://datatracker.ietf.org/doc/html/rfc9000>RFC-9000</a> and <a href=https://datatracker.ietf.org/doc/html/rfc9001>RFC-9001</a>.
So we need to generate and install certificates. For the demo, I&rsquo;m using self-signed certificates.</p><ol><li>Parameters for the certificate (Like SAN). Save it as <code>httpbin.cfg</code></li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cfg data-lang=cfg><span style=display:flex><span><span style=color:#000;font-weight:700>[req]</span>
</span></span><span style=display:flex><span><span style=color:teal>default_bits</span>       <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>2048</span>
</span></span><span style=display:flex><span><span style=color:teal>prompt</span>             <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>no</span>
</span></span><span style=display:flex><span><span style=color:teal>distinguished_name</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>req_distinguished_name</span>
</span></span><span style=display:flex><span><span style=color:teal>req_extensions</span>     <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>san_reqext</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>[ req_distinguished_name ]</span>
</span></span><span style=display:flex><span><span style=color:teal>countryName</span>         <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>XX</span>
</span></span><span style=display:flex><span><span style=color:teal>stateOrProvinceName</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>YY</span>
</span></span><span style=display:flex><span><span style=color:teal>organizationName</span>    <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>QuicCorp</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>[ san_reqext ]</span>
</span></span><span style=display:flex><span><span style=color:teal>subjectAltName</span>      <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>@alt_names</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>[alt_names]</span>
</span></span><span style=display:flex><span><span style=color:teal>DNS.0</span>   <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>httpbin.quic-corp.com</span>
</span></span></code></pre></div><ol start=2><li>Generate TLS certificates and keys with the following script. Here, I&rsquo;m using <code>openssl</code>. You can
use other tools like <code>cfssl</code> as well.</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ openssl req -x509 -sha256 -nodes -days <span style=color:#099>365</span> -newkey rsa:4096 -subj <span style=color:#d14>\
</span></span></span><span style=display:flex><span><span style=color:#d14></span>    <span style=color:#d14>&#34;/C=XX/ST=YY/O=QuicCorp&#34;</span> -keyout quiccorp-ca.key -out quiccorp-ca.crt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ openssl req -out httpbin.csr -newkey rsa:2048 -nodes <span style=color:#d14>\
</span></span></span><span style=display:flex><span><span style=color:#d14></span>    -keyout httpbin.key -config httpbin.cnf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ openssl x509 -req -days <span style=color:#099>365</span> -CA quiccorp-ca.crt -CAkey quiccorp-ca.key <span style=color:#d14>\
</span></span></span><span style=display:flex><span><span style=color:#d14></span>    -set_serial <span style=color:#099>0</span> -in httpbin.csr -out httpbin.crt <span style=color:#d14>\
</span></span></span><span style=display:flex><span><span style=color:#d14></span>    -extfile httpbin.cnf -extensions san_reqext
</span></span></code></pre></div><ol start=3><li>Install the certificates</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl -n istio-system create secret tls httpbin-cred <span style=color:#d14>\
</span></span></span><span style=display:flex><span><span style=color:#d14></span>    --key<span style=color:#000;font-weight:700>=</span>httpbin.key --cert<span style=color:#000;font-weight:700>=</span>httpbin.crt
</span></span></code></pre></div><h3 id=istio-configuration>Istio configuration</h3><p>Remember, HTTP/3 listener is generated <strong>automatically</strong> for TLS-terminated HTTPS listener. Currently,
specifying that a port is HTTP/3-only is not yet supported. This is because HTTP/3 support is not widespread
yet and the most common use case is for the clients like Google Chrome to become aware of HTTP/3 support
with <code>alt-svc</code> HTTP header in the response when they first use HTTP/1.1 or HTTP/2 over TCP.</p><p>Configure the gateway. Notice that there is no explicit HTTP/3 related configuration</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:navy>apiVersion</span>:<span style=color:#bbb> </span>networking.istio.io/v1beta1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:navy>kind</span>:<span style=color:#bbb> </span>Gateway<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:navy>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:navy>name</span>:<span style=color:#bbb> </span>httpbin-gateway<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:navy>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:navy>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:navy>app</span>:<span style=color:#bbb> </span>istio-ingressgateway<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:navy>istio</span>:<span style=color:#bbb> </span>ingressgateway<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:navy>servers</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:navy>port</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:navy>number</span>:<span style=color:#bbb> </span><span style=color:#099>443</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:navy>name</span>:<span style=color:#bbb> </span>https<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:navy>protocol</span>:<span style=color:#bbb> </span>HTTPS<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:navy>hosts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- httpbin.quic-corp.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:navy>tls</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:navy>mode</span>:<span style=color:#bbb> </span>SIMPLE<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:navy>credentialName</span>:<span style=color:#bbb> </span>httpbin-cred<span style=color:#bbb>
</span></span></span></code></pre></div><p>Configure the route</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:navy>apiVersion</span>:<span style=color:#bbb> </span>networking.istio.io/v1beta1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:navy>kind</span>:<span style=color:#bbb> </span>VirtualService<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:navy>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:navy>name</span>:<span style=color:#bbb> </span>httpbin-route<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:navy>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:navy>hosts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- httpbin.quic-corp.com<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:navy>gateways</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- httpbin-gateway<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:navy>http</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:navy>name</span>:<span style=color:#bbb> </span>httpbin-default-route<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:navy>route</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:navy>destination</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:navy>host</span>:<span style=color:#bbb> </span>httpbin.httpbin.svc.cluster.local<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:navy>port</span>:<span style=color:#bbb> 
</span></span></span><span style=display:flex><span><span style=color:#bbb>          </span><span style=color:navy>number</span>:<span style=color:#bbb> </span><span style=color:#099>8000</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>Once these routes are applied, check if two listeners are created</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ istioctl proxy-config listeners istio-ingressgateway-6fdcddbb8b-9rpkx.istio-system
</span></span><span style=display:flex><span>ADDRESS PORT  MATCH                      DESTINATION
</span></span><span style=display:flex><span>0.0.0.0 <span style=color:#099>8443</span>  SNI: httpbin.quic-corp.com Route: https.443.https.httpbin-gateway.istio-system
</span></span><span style=display:flex><span>0.0.0.0 <span style=color:#099>8443</span>  SNI: httpbin.quic-corp.com Route: https.443.https.httpbin-gateway.istio-system
</span></span><span style=display:flex><span>0.0.0.0 <span style=color:#099>15021</span> ALL                        Inline Route: /healthz/ready*
</span></span><span style=display:flex><span>0.0.0.0 <span style=color:#099>15090</span> ALL                        Inline Route: /stats/prometheus*
</span></span></code></pre></div><p>Where did the other inbound listener come from? Let us dive deeper into the config.
Let us start with checking listener names</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ istioctl proxy-config listeners istio-ingressgateway-6fdcddbb8b-9rpkx.istio-system <span style=color:#d14>\
</span></span></span><span style=display:flex><span><span style=color:#d14></span>    --address 0.0.0.0 --port <span style=color:#099>8443</span> -o json | jq -r <span style=color:#d14>&#39;.[].name&#39;</span>
</span></span><span style=display:flex><span>0.0.0.0_8443
</span></span><span style=display:flex><span>udp_0.0.0.0_8443
</span></span></code></pre></div><p>UDP?? Remember that QUIC uses UDP. So could this be related to QUIC? Let us dive deeper.
The output is huge and only the relevant part is shown here. So pipe it to a pager like <code>less</code></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:navy>&#34;transportSocket&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:navy>&#34;name&#34;</span>: <span style=color:#d14>&#34;envoy.transport_sockets.quic&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:navy>&#34;typedConfig&#34;</span>: {
</span></span><span style=display:flex><span>          <span style=color:navy>&#34;@type&#34;</span>: <span style=color:#d14>&#34;type.googleapis.com/envoy.extensions.transport_sockets.quic.v3.QuicDownstreamTransport&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:navy>&#34;downstreamTlsContext&#34;</span>: {
</span></span><span style=display:flex><span>              <span style=color:navy>&#34;commonTlsContext&#34;</span>: {
</span></span><span style=display:flex><span>                  <span style=color:navy>&#34;tlsCertificateSdsSecretConfigs&#34;</span>: [
</span></span><span style=display:flex><span>                      {
</span></span><span style=display:flex><span>                          <span style=color:navy>&#34;name&#34;</span>: <span style=color:#d14>&#34;kubernetes://httpbin-cred&#34;</span>,
</span></span><span style=display:flex><span>                          <span style=color:navy>&#34;sdsConfig&#34;</span>: {
</span></span><span style=display:flex><span>                              <span style=color:navy>&#34;ads&#34;</span>: {},
</span></span><span style=display:flex><span>                              <span style=color:navy>&#34;resourceApiVersion&#34;</span>: <span style=color:#d14>&#34;V3&#34;</span>
</span></span><span style=display:flex><span>                          }
</span></span><span style=display:flex><span>                      }
</span></span><span style=display:flex><span>                  ],
</span></span><span style=display:flex><span>                  <span style=color:navy>&#34;alpnProtocols&#34;</span>: [
</span></span><span style=display:flex><span>                      <span style=color:#d14>&#34;h3&#34;</span>
</span></span><span style=display:flex><span>                  ]
</span></span><span style=display:flex><span>              },
</span></span><span style=display:flex><span>              <span style=color:navy>&#34;requireClientCertificate&#34;</span>: <span style=color:#000;font-weight:700>false</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Well&mldr;The one with <code>udp</code> prefix is a QUIC listener!</p><h2 id=demo-time>Demo time</h2><p>First note down the address of the Ingress gateway</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl -n istio-system get svc
</span></span><span style=display:flex><span>NAME                   TYPE           CLUSTER-IP      EXTERNAL-IP    PORT<span style=color:#000;font-weight:700>(</span>S<span style=color:#000;font-weight:700>)</span>                                       AGE
</span></span><span style=display:flex><span>istio-ingressgateway   LoadBalancer   10.96.112.53    172.18.200.1   15021:32534/TCP,443:31597/TCP,443:31597/UDP   79m
</span></span><span style=display:flex><span>istiod                 ClusterIP      10.96.255.123   &lt;none&gt;         15010/TCP,15012/TCP,443/TCP,15014/TCP         79m
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ <span style=color:#0086b3>export</span> <span style=color:teal>INGRESS_IP</span><span style=color:#000;font-weight:700>=</span>172.18.200.1
</span></span></code></pre></div><p>I have a custom build of curl called <code>qcurl</code> which supports sending HTTP/3 request with
<code>--http3</code> flag. <code>curl</code> here is the standard curl available in the software repositories.
For demo purposes, I&rsquo;m skipping TLS certificate verification. Don&rsquo;t this if it is not a demo.</p><p>Let us first send HTTP/2 request</p><pre tabindex=0><code>$ curl -svk --http2 --resolve httpbin.quic-corp.com:443:$INGRESS_IP https://httpbin.quic-corp.com/headers
[ Output truncated ]
...
&gt; GET /headers HTTP/2
&gt; Host: httpbin.quic-corp.com
&gt; user-agent: curl/7.76.1
&gt; accept: */*
...
&lt; HTTP/2 200 
&lt; server: istio-envoy
&lt; date: Wed, 27 Oct 2021 05:05:59 GMT
&lt; content-type: application/json
&lt; content-length: 601
&lt; access-control-allow-origin: *
&lt; access-control-allow-credentials: true
&lt; x-envoy-upstream-service-time: 1
&lt; alt-svc: h3=&#34;:443&#34;; ma=86400
&lt; 
{
  &#34;headers&#34;: {
    &#34;Accept&#34;: &#34;*/*&#34;, 
    &#34;Host&#34;: &#34;httpbin.quic-corp.com&#34;, 
    &#34;User-Agent&#34;: &#34;curl/7.76.1&#34;, 
    &#34;X-B3-Parentspanid&#34;: &#34;819c2b2cab59bbe8&#34;, 
    &#34;X-B3-Sampled&#34;: &#34;0&#34;, 
    &#34;X-B3-Spanid&#34;: &#34;0462ac631afb5f84&#34;, 
    &#34;X-B3-Traceid&#34;: &#34;3fa44e3bbbcd21a3819c2b2cab59bbe8&#34;, 
    &#34;X-Envoy-Attempt-Count&#34;: &#34;1&#34;, 
    &#34;X-Envoy-Internal&#34;: &#34;true&#34;, 
    &#34;X-Forwarded-Client-Cert&#34;: &#34;By=spiffe://cluster.local/ns/httpbin/sa/httpbin;Hash=97bf9c90d4a5b9bb8f5da3e825dfa34f04631400420649394741807a320aa0a1;Subject=\&#34;\&#34;;URI=spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account&#34;
  }
}
</code></pre><p>Yayyy! It is working. In particular notice this header</p><pre tabindex=0><code>alt-svc: h3=&#34;:443&#34;; ma=86400
</code></pre><p>It indicates that HTTP/3 is supported. <code>h3</code> is the ALPN sent with the TLS handshake.
Clients supporting HTTP/3 can use this information to connect with QUIC for the future
connections. <strong>Now, let us send an HTTP/3 request</strong></p><pre tabindex=0><code>$ qcurl -svk --http3 --resolve httpbin.quic-corp.com:443:$INGRESS_IP https://httpbin.quic-corp.com/headers
* Added httpbin.quic-corp.com:443:172.18.200.1 to DNS cache
* Hostname httpbin.quic-corp.com was found in DNS cache
*   Trying 172.18.200.1:443...
* Connect socket 5 over QUIC to 172.18.200.1:443
* Sent QUIC client Initial, ALPN: h3,h3-29,h3-28,h3-27
* Connected to httpbin.quic-corp.com () port 443 (#0)
* h3 [:method: GET]
* h3 [:path: /headers]
* h3 [:scheme: https]
* h3 [:authority: httpbin.quic-corp.com]
* h3 [user-agent: curl/7.78.0-DEV]
* h3 [accept: */*]
* Using HTTP/3 Stream ID: 0 (easy handle 0xa64260)
&gt; GET /headers HTTP/3
&gt; Host: httpbin.quic-corp.com
&gt; user-agent: curl/7.78.0-DEV
&gt; accept: */*
&gt; 
&lt; HTTP/3 200
&lt; server: istio-envoy
&lt; date: Wed, 27 Oct 2021 05:08:46 GMT
&lt; content-type: application/json
&lt; content-length: 642
&lt; access-control-allow-origin: *
&lt; access-control-allow-credentials: true
&lt; x-envoy-upstream-service-time: 2
&lt; alt-svc: h3=&#34;:443&#34;; ma=86400
&lt; 
{
  &#34;headers&#34;: {
    &#34;Accept&#34;: &#34;*/*&#34;, 
    &#34;Host&#34;: &#34;httpbin.quic-corp.com&#34;, 
    &#34;Transfer-Encoding&#34;: &#34;chunked&#34;, 
    &#34;User-Agent&#34;: &#34;curl/7.78.0-DEV&#34;, 
    &#34;X-B3-Parentspanid&#34;: &#34;d9f3d78e3f6ddc5c&#34;, 
    &#34;X-B3-Sampled&#34;: &#34;0&#34;, 
    &#34;X-B3-Spanid&#34;: &#34;3f6c920b02a92b73&#34;, 
    &#34;X-B3-Traceid&#34;: &#34;d5c22cd31ddec119d9f3d78e3f6ddc5c&#34;, 
    &#34;X-Envoy-Attempt-Count&#34;: &#34;1&#34;, 
    &#34;X-Envoy-Internal&#34;: &#34;true&#34;, 
    &#34;X-Forwarded-Client-Cert&#34;: &#34;By=spiffe://cluster.local/ns/httpbin/sa/httpbin;Hash=97bf9c90d4a5b9bb8f5da3e825dfa34f04631400420649394741807a320aa0a1;Subject=\&#34;\&#34;;URI=spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account&#34;
  }
}
</code></pre><p>And&mldr;.. <strong>IT WORKS!</strong></p></div><div class=back-to-top><a href=#top>back to top</a></div></div></main></div><footer><p>Powered by
<a href=https://gohugo.io/>Hugo</a>
and
<a href=https://github.com/tomfran/typo>tomfran/typo</a></p></footer></body><script>function isAuto(){return document.body.classList.contains("auto")}function setTheme(){if(!isAuto())return;document.body.classList.remove("auto");let e="light";window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches&&(e="dark"),document.body.classList.add(e)}function invertBody(){document.body.classList.toggle("dark"),document.body.classList.toggle("light")}isAuto()&&window.matchMedia("(prefers-color-scheme: dark)").addListener(invertBody),setTheme()</script></html>